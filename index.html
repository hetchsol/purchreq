<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Purchase Management System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        /* Color Palette */
        :root {
            --primary-blue: #03045E;
            --secondary-blue: #0077B6;
            --accent-blue: #00B4D8;
            --dark-grey: #3E3E4D;
            --medium-grey: #4F4E5E;
            --light-grey: #7D7981;
            --lighter-grey: #9896AA;
        }
        
        body { 
            font-family: 'Calibri Light', 'Calibri', 'Segoe UI', 'Helvetica Neue', Arial, sans-serif;
            font-weight: 300;
            transition: background-color 0.3s, color 0.3s;
        }
        
        /* Light Mode (Default) */
        body.light-mode {
            background-color: #f5f7fa;
            color: var(--dark-grey);
        }
        body.light-mode .sidebar {
            background: linear-gradient(180deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            color: #ffffff;
            box-shadow: 2px 0 10px rgba(3, 4, 94, 0.1);
        }
        body.light-mode .sidebar h4 {
            color: #ffffff;
            font-weight: 600;
            letter-spacing: 1px;
        }
        body.light-mode .sidebar hr {
            border-color: rgba(255, 255, 255, 0.2);
        }
        body.light-mode .nav-link {
            color: rgba(255, 255, 255, 0.85);
            padding: 10px 15px;
            border-radius: 8px;
            transition: all 0.3s;
            margin-bottom: 5px;
        }
        body.light-mode .nav-link:hover {
            background-color: rgba(255, 255, 255, 0.15);
            color: #ffffff;
            transform: translateX(5px);
        }
        body.light-mode .card {
            background-color: #ffffff;
            color: var(--dark-grey);
            border: none;
            box-shadow: 0 2px 8px rgba(3, 4, 94, 0.08);
            border-radius: 12px;
        }
        body.light-mode .card-header {
            background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--accent-blue) 100%);
            color: #ffffff;
            border-bottom: none;
            font-weight: 600;
            border-radius: 12px 12px 0 0 !important;
        }
        body.light-mode .table {
            color: var(--dark-grey);
        }
        body.light-mode .table thead th {
            background-color: var(--primary-blue);
            color: #ffffff;
            border: none;
            font-weight: 600;
        }
        body.light-mode .btn-primary {
            background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--accent-blue) 100%);
            border: none;
            box-shadow: 0 4px 6px rgba(0, 119, 182, 0.3);
        }
        body.light-mode .btn-primary:hover {
            background: linear-gradient(135deg, var(--primary-blue) 0%, var(--secondary-blue) 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 119, 182, 0.4);
        }
        body.light-mode .stat-card {
            background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--accent-blue) 100%);
            border: none;
            box-shadow: 0 4px 12px rgba(0, 119, 182, 0.2);
        }
        body.light-mode .login-container .card {
            box-shadow: 0 8px 24px rgba(3, 4, 94, 0.15);
            border: none;
        }
        
        /* Dark Mode */
        body.dark-mode {
            background-color: #1a1a2e;
            color: var(--lighter-grey);
        }
        body.dark-mode .sidebar {
            background: linear-gradient(180deg, var(--dark-grey) 0%, var(--medium-grey) 100%);
            color: var(--lighter-grey);
            border-right: 1px solid var(--light-grey);
        }
        body.dark-mode .sidebar h4 {
            color: var(--accent-blue);
            font-weight: 600;
        }
        body.dark-mode .sidebar hr {
            border-color: var(--light-grey);
        }
        body.dark-mode .nav-link {
            color: var(--lighter-grey);
            padding: 10px 15px;
            border-radius: 8px;
            transition: all 0.3s;
            margin-bottom: 5px;
        }
        body.dark-mode .nav-link:hover {
            background-color: rgba(0, 180, 216, 0.2);
            color: var(--accent-blue);
            transform: translateX(5px);
        }
        body.dark-mode .card {
            background-color: var(--dark-grey);
            color: var(--lighter-grey);
            border: 1px solid var(--medium-grey);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-radius: 12px;
        }
        body.dark-mode .card-header {
            background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--accent-blue) 100%);
            color: #ffffff;
            border-bottom: 1px solid var(--light-grey);
            font-weight: 600;
            border-radius: 12px 12px 0 0 !important;
        }
        body.dark-mode .table {
            color: var(--lighter-grey);
            border-color: var(--light-grey);
        }
        body.dark-mode .table thead th {
            background-color: var(--secondary-blue);
            color: #ffffff;
            border-color: var(--light-grey);
            font-weight: 600;
        }
        body.dark-mode .table-striped tbody tr:nth-of-type(odd) {
            background-color: rgba(79, 78, 94, 0.3);
        }
        body.dark-mode .table-hover tbody tr:hover {
            background-color: rgba(0, 180, 216, 0.1);
        }
        body.dark-mode .form-control,
        body.dark-mode .form-select {
            background-color: var(--medium-grey);
            color: var(--lighter-grey);
            border-color: var(--light-grey);
        }
        body.dark-mode .form-control:focus,
        body.dark-mode .form-select:focus {
            background-color: var(--medium-grey);
            color: var(--lighter-grey);
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 0.2rem rgba(0, 180, 216, 0.25);
        }
        body.dark-mode .modal-content {
            background-color: var(--dark-grey);
            color: var(--lighter-grey);
            border: 1px solid var(--light-grey);
        }
        body.dark-mode .modal-header {
            border-bottom-color: var(--light-grey);
            background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--accent-blue) 100%);
            color: #ffffff;
        }
        body.dark-mode .modal-footer {
            border-top-color: var(--light-grey);
        }
        body.dark-mode .btn-close {
            filter: invert(1);
        }
        body.dark-mode .alert {
            border-color: var(--light-grey);
            background-color: var(--medium-grey);
        }
        body.dark-mode .login-container .card {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
            background: var(--dark-grey);
            border: 1px solid var(--light-grey);
        }
        body.dark-mode .text-muted {
            color: var(--light-grey) !important;
        }
        body.dark-mode .table-warning {
            background-color: rgba(0, 180, 216, 0.2) !important;
        }
        body.dark-mode .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
            color: #fff;
        }
        body.dark-mode .btn-success {
            background-color: #28a745;
            border-color: #28a745;
            color: #fff;
        }
        body.dark-mode .btn-primary {
            background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--accent-blue) 100%);
            border: none;
        }
        body.dark-mode .stat-card {
            background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--accent-blue) 100%);
        }
        body.dark-mode .progress {
            background-color: var(--medium-grey);
        }
        
        /* Ensure buttons are visible */
        .btn {
            cursor: pointer;
            border-radius: 8px;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        /* Item table styling */
        #itemsTable textarea.form-control {
            min-height: 50px;
        }
        #itemsTable .btn-sm {
            padding: 2px 8px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        /* Theme Toggle Button */
        .theme-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--accent-blue) 100%);
            color: white;
            font-size: 20px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 119, 182, 0.4);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .theme-toggle:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 119, 182, 0.5);
        }
        .theme-toggle:active {
            transform: translateY(-1px);
        }
        
        .sidebar {
            min-height: 100vh;
            padding: 20px;
            transition: background-color 0.3s, color 0.3s;
        }
        .hidden { display: none !important; }
        .badge-pending { background-color: #ffc107; color: #000; }
        .badge-approved { background-color: #28a745; }
        .badge-rejected { background-color: #dc3545; }
        .badge-draft { background-color: var(--light-grey); }
        .stat-card { 
            transition: transform 0.2s;
            border-radius: 12px;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .login-container {
            max-width: 400px;
            margin: 100px auto;
        }
        .table-responsive { max-height: 400px; overflow-y: auto; }
        .action-buttons { display: flex; gap: 5px; flex-wrap: wrap; }
        
        /* Enhanced card styling */
        .card {
            border-radius: 12px;
            overflow: hidden;
        }
        
        /* Progress bar styling */
        .progress {
            border-radius: 8px;
            height: 25px;
        }
        .progress-bar {
            border-radius: 8px;
            font-weight: 600;
        }
        
        /* Table styling */
        .table {
            border-radius: 8px;
            overflow: hidden;
        }
        .table thead th {
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>

<!-- Theme Toggle Button - Always Visible -->
<button class="theme-toggle" id="themeToggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
    <span id="themeIcon">üåô</span>
</button>

<!-- LOGIN SCREEN -->
<div id="loginScreen">
    <div class="login-container">
        <div class="card">
            <div class="card-body">
                <h2 class="text-center mb-4">Purchase Management System</h2>
                <form id="loginForm">
                    <div class="mb-3">
                        <label class="form-label">Username</label>
                        <input type="text" class="form-control" id="loginUsername" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Password</label>
                        <input type="password" class="form-control" id="loginPassword" required>
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Login</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- MAIN APPLICATION -->
<div id="appScreen" class="hidden">
    <div class="container-fluid">
        <div class="row">
            <!-- SIDEBAR -->
            <nav class="col-md-2 sidebar">
                <h4>Purchase System</h4>
                <hr>
                <ul class="nav flex-column">
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showScreen('dashboard')">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showScreen('createRequisition')">New Requisition</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showScreen('myRequisitions')">My Requisitions</a>
                    </li>
                    <li class="nav-item" id="allRequisitionsMenuItem">
                        <a class="nav-link" href="#" onclick="showScreen('allRequisitions')">All Requisitions</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showScreen('approvedRequisitions')">Approved Requisitions</a>
                    </li>
                    <li class="nav-item" id="budgetMenuItem">
                        <a class="nav-link" href="#" onclick="showScreen('budgets')">Budgets</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showScreen('pendingApprovals')">Pending Approvals</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="showScreen('reports')">Reports</a>
                    </li>
                    <li class="nav-item" id="adminMenuItem">
                        <a class="nav-link" href="#" onclick="showScreen('adminPanel')">Admin Panel</a>
                    </li>
                    <li class="nav-item mt-3">
                        <a class="nav-link text-danger" href="#" onclick="logout()">Logout</a>
                    </li>
                </ul>
                <hr>
                <p class="small text-muted">User: <span id="currentUserDisplay"></span><br>
                Dept: <span id="currentDeptDisplay"></span></p>
            </nav>

            <!-- MAIN CONTENT -->
            <main class="col-md-10 px-4 py-3">
                <div id="alertContainer"></div>

                <!-- DASHBOARD -->
                <div id="dashboardScreen" class="content-screen">
                    <h1>Dashboard</h1>
                    <div class="row mt-4 g-3">
                        <div class="col-md-3 col-sm-6">
                            <div class="card text-white stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ffb300 100%);">
                                <div class="card-body text-center py-3">
                                    <h6 class="mb-2">Pending</h6>
                                    <p class="display-6 mb-0" id="statPending">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="card text-white stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
                                <div class="card-body text-center py-3">
                                    <h6 class="mb-2">Approved</h6>
                                    <p class="display-6 mb-0" id="statApproved">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="card text-white stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #e63946 100%);">
                                <div class="card-body text-center py-3">
                                    <h6 class="mb-2">Rejected</h6>
                                    <p class="display-6 mb-0" id="statRejected">0</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-3 col-sm-6">
                            <div class="card text-white stat-card" style="background: linear-gradient(135deg, var(--secondary-blue) 0%, var(--accent-blue) 100%);">
                                <div class="card-body text-center py-3">
                                    <h6 class="mb-2">Drafts</h6>
                                    <p class="display-6 mb-0" id="statDrafts">0</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card mt-4" id="pendingApprovalsCard">
                        <div class="card-header bg-warning">
                            <h5>Requisitions Awaiting Your Approval</h5>
                        </div>
                        <div class="card-body">
                            <div id="dashboardPendingList"></div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>My Recent Requisitions</h5>
                        </div>
                        <div class="card-body">
                            <div id="dashboardRecentList"></div>
                        </div>
                    </div>
                </div>

                <!-- CREATE REQUISITION -->
                <div id="createRequisitionScreen" class="content-screen hidden">
                    <h1 id="reqFormTitle">Create New Requisition</h1>
                    <div class="card mt-4">
                        <div class="card-body">
                            <form id="requisitionForm">
                                <input type="hidden" id="editReqId">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Department</label>
                                        <input type="text" class="form-control" id="reqDepartment" readonly>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Account Code</label>
                                        <input type="text" class="form-control" id="reqAccountCode" readonly>
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Vendor</label>
                                    <select class="form-control" id="reqVendor" required>
                                        <option value="">Select Vendor</option>
                                    </select>
                                </div>

                                <!-- Items Section -->
                                <div class="mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <label class="form-label mb-0"><strong>Items to Purchase</strong></label>
                                        <button type="button" class="btn btn-sm btn-success" onclick="addItemRow(); return false;">
                                            <strong>+ Add Item</strong>
                                        </button>
                                    </div>
                                    <div class="table-responsive" style="max-height: none;">
                                        <table class="table table-bordered" id="itemsTable">
                                            <thead class="table-light">
                                                <tr>
                                                    <th style="width: 5%">#</th>
                                                    <th style="width: 35%">Item Description *</th>
                                                    <th style="width: 15%">Quantity *</th>
                                                    <th style="width: 15%">Unit Cost (ZMW) *</th>
                                                    <th style="width: 15%">Total</th>
                                                    <th style="width: 15%">Action</th>
                                                </tr>
                                            </thead>
                                            <tbody id="itemsTableBody">
                                                <!-- Items will be added here dynamically -->
                                            </tbody>
                                            <tfoot class="table-light">
                                                <tr>
                                                    <td colspan="4" class="text-end"><strong>Grand Total:</strong></td>
                                                    <td colspan="2"><strong id="grandTotal">ZMW 0.00</strong></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>
                                    <small class="text-muted">You can add up to 30 items per requisition. Click "+ Add Item" to add more rows.</small>
                                </div>

                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Urgency</label>
                                        <select class="form-control" id="reqUrgency">
                                            <option value="LOW">Low</option>
                                            <option value="MEDIUM" selected>Medium</option>
                                            <option value="HIGH">High</option>
                                            <option value="URGENT">Urgent</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Required By</label>
                                        <input type="date" class="form-control" id="reqRequiredBy" min="">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Justification</label>
                                    <textarea class="form-control" id="reqJustification" rows="3" required></textarea>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label">Delivery Location</label>
                                    <select class="form-control" id="reqLocation" required>
                                        <option value="">Select Location</option>
                                        <option value="Kitwe">Kitwe</option>
                                        <option value="Lusaka">Lusaka</option>
                                        <option value="Solwezi">Solwezi</option>
                                       <!-- <option value="Ndola">Ndola</option>
                                        <option value="Livingstone">Livingstone</option>-->
                                    </select>
                                </div>

                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary">Submit for Approval</button>
                                    <button type="button" class="btn btn-secondary" onclick="saveDraft()">Save as Draft</button>
                                    <button type="button" class="btn btn-outline-secondary" onclick="cancelEdit()">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- MY REQUISITIONS -->
                <div id="myRequisitionsScreen" class="content-screen hidden">
                    <h1>My Requisitions</h1>
                    <div class="card mt-4">
                        <div class="card-body">
                            <div class="mb-3">
                                <button class="btn btn-sm btn-warning" onclick="filterRequisitions('PENDING')">Pending</button>
                                <button class="btn btn-sm btn-success" onclick="filterRequisitions('APPROVED')">Approved</button>
                                <button class="btn btn-sm btn-danger" onclick="filterRequisitions('REJECTED')">Rejected</button>
                                <button class="btn btn-sm btn-secondary" onclick="filterRequisitions('DRAFT')">Drafts</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="filterRequisitions('ALL')">All</button>
                            </div>
                            <div id="myRequisitionsList"></div>
                        </div>
                    </div>
                </div>

                <!-- ALL REQUISITIONS (ADMIN) -->
                <div id="allRequisitionsScreen" class="content-screen hidden">
                    <h1>All Requisitions</h1>
                    <div class="card mt-4">
                        <div class="card-body">
                            <div class="mb-3">
                                <button class="btn btn-sm btn-warning" onclick="filterAllRequisitions('PENDING')">Pending</button>
                                <button class="btn btn-sm btn-success" onclick="filterAllRequisitions('APPROVED')">Approved</button>
                                <button class="btn btn-sm btn-danger" onclick="filterAllRequisitions('REJECTED')">Rejected</button>
                                <button class="btn btn-sm btn-secondary" onclick="filterAllRequisitions('DRAFT')">Drafts</button>
                                <button class="btn btn-sm btn-outline-secondary" onclick="filterAllRequisitions('ALL')">All</button>
                            </div>
                            <div id="allRequisitionsList"></div>
                        </div>
                    </div>
                </div>

                <!-- REQUISITION DETAIL -->
                <div id="requisitionDetailScreen" class="content-screen hidden">
                    <div id="requisitionDetailContent"></div>
                </div>

                <!-- PENDING APPROVALS -->
                <div id="pendingApprovalsScreen" class="content-screen hidden">
                    <h1>Pending Approvals</h1>
                    <div class="card mt-4">
                        <div class="card-body">
                            <p class="text-muted" id="pendingApprovalsInfo"></p>
                            <div id="pendingApprovalsList"></div>
                        </div>
                    </div>
                </div>

                <!-- APPROVED REQUISITIONS -->
                <div id="approvedRequisitionsScreen" class="content-screen hidden">
                    <h1>Approved Requisitions</h1>
                    <div class="card mt-4">
                        <div class="card-body">
                            <p class="text-muted" id="approvedReqsInfo"></p>
                            <div id="approvedRequisitionsList"></div>
                        </div>
                    </div>
                </div>

                <!-- BUDGETS -->
                <div id="budgetsScreen" class="content-screen hidden">
                    <h1>Budget Management</h1>
                    
                    <!-- Budget Overview Cards -->
                    <div class="row mt-4" id="budgetOverviewCards">
                        <!-- Cards will be populated here -->
                    </div>

                    <!-- Budget Management Table (Finance Manager, MD, Admin) -->
                    <div class="card mt-4" id="budgetManagementCard">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Department Budgets</h5>
                            <button class="btn btn-sm btn-primary" id="editBudgetsBtn" onclick="toggleBudgetEdit()">Edit Budgets</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="budgetManagementTable">
                                    <thead class="table-light">
                                        <tr>
                                            <th>Department</th>
                                            <th>Account Code</th>
                                            <th>Allocated Budget (ZMW)</th>
                                            <th>Spent (ZMW)</th>
                                            <th>Available (ZMW)</th>
                                            <th>% Consumed</th>
                                            <th>Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="budgetTableBody">
                                        <!-- Budget rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- HOD Budget View -->
                    <div class="card mt-4" id="hodBudgetCard">
                        <div class="card-header bg-info text-white">
                            <h5>My Department Budget</h5>
                        </div>
                        <div class="card-body">
                            <div id="hodBudgetView"></div>
                        </div>
                    </div>

                    <!-- Recent Requisitions Impact -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>Recent Requisitions Impact on Budget</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-sm">
                                    <thead>
                                        <tr>
                                            <th>Req #</th>
                                            <th>Date</th>
                                            <th>Department</th>
                                            <th>Description</th>
                                            <th>Amount</th>
                                            <th>Budget Impact</th>
                                        </tr>
                                    </thead>
                                    <tbody id="budgetImpactTableBody">
                                        <!-- Recent approved requisitions -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- REPORTS -->
                <div id="reportsScreen" class="content-screen hidden">
                    <div class="d-flex justify-content-between align-items-center">
                        <h1>Reports & Analytics</h1>
                        <div>
                            <button class="btn btn-sm btn-danger" onclick="downloadReportsPDF()">Download PDF</button>
                            <button class="btn btn-sm btn-success" onclick="downloadReportsExcel()">Download Excel</button>
                        </div>
                    </div>
                    
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>Spending by Department</h5>
                        </div>
                        <div class="card-body">
                            <div id="deptSpendingReport"></div>
                        </div>
                    </div>

                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>Status Summary</h5>
                        </div>
                        <div class="card-body">
                            <div id="statusSummaryReport"></div>
                        </div>
                    </div>
                </div>

                <!-- ADMIN PANEL -->
                <div id="adminPanelScreen" class="content-screen hidden">
                    <h1>Admin Panel</h1>

                    <!-- User Management -->
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>User Management</h5>
                            <button class="btn btn-sm btn-primary" onclick="showAddUser()">Add User</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <div id="usersList"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Add User Form -->
                    <div class="card mt-4 hidden" id="addUserForm">
                        <div class="card-header">
                            <h5>Add User</h5>
                        </div>
                        <div class="card-body">
                            <form id="userForm">
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Full Name</label>
                                        <input type="text" class="form-control" id="userName" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Username</label>
                                        <input type="text" class="form-control" id="userUsername" required>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Password</label>
                                        <input type="password" class="form-control" id="userPassword" required>
                                    </div>
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Role</label>
                                        <select class="form-control" id="userRole" required>
                                            <option value="initiator">Initiator</option>
                                            <option value="hod">HOD (Department Approver)</option>
                                            <option value="finance_manager">Finance Manager</option>
                                            <option value="md">Managing Director (MD)</option>
                                            <option value="admin">Admin</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6 mb-3">
                                        <label class="form-label">Department</label>
                                        <select class="form-control" id="userDepartment" required>
                                            <option value="">Select Department</option>
                                            <option value="Engineering">Engineering</option>
                                            <option value="Finance">Finance</option>
                                            <option value="Sales">Sales</option>
                                            <option value="IT">IT</option>
                                            <option value="HR">HR</option>
                                            <option value="Executive">Executive</option>
                                            <option value="Admin">Admin</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6 mb-3" id="hodFieldContainer">
                                        <label class="form-label">HOD (if Initiator)</label>
                                        <select class="form-control" id="userHOD">
                                            <option value="">Select HOD</option>
                                        </select>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-primary">Save User</button>
                                <button type="button" class="btn btn-secondary" onclick="hideAddUser()">Cancel</button>
                            </form>
                        </div>
                    </div>
                    
                    <!-- Vendors -->
                    <div class="card mt-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5>Vendor Management</h5>
                            <button class="btn btn-sm btn-primary" onclick="showAddVendor()">Add Vendor</button>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <div id="vendorsList"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Add Vendor Form -->
                    <div class="card mt-4 hidden" id="addVendorForm">
                        <div class="card-header">
                            <h5>Add Vendor</h5>
                        </div>
                        <div class="card-body">
                            <form id="vendorForm">
                                <div class="mb-3">
                                    <label class="form-label">Vendor Name</label>
                                    <input type="text" class="form-control" id="vendorName" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="vendorEmail">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Phone</label>
                                    <input type="text" class="form-control" id="vendorPhone">
                                </div>
                                <button type="submit" class="btn btn-primary">Save Vendor</button>
                                <button type="button" class="btn btn-secondary" onclick="hideAddVendor()">Cancel</button>
                            </form>
                        </div>
                    </div>

                    <!-- Departments -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h5>Departments & Account Codes</h5>
                        </div>
                        <div class="card-body">
                            <div id="departmentsList"></div>
                        </div>
                    </div>

                    <!-- Data Management -->
                    <div class="card mt-4">
                        <div class="card-header bg-danger text-white">
                            <h5>Data Management</h5>
                        </div>
                        <div class="card-body">
                            <div class="alert alert-warning">
                                <strong>Warning:</strong> These actions will affect all stored data.
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-info" onclick="exportAllData()">Export All Data (JSON)</button>
                                <button class="btn btn-warning" onclick="document.getElementById('importFile').click()">Import Data (JSON)</button>
                                <button class="btn btn-danger" onclick="clearAllData()">Clear All Data</button>
                            </div>
                            <input type="file" id="importFile" accept=".json" style="display: none;" onchange="importAllData(event)">
                            <div class="mt-3 small text-muted">
                                <strong>Storage Status:</strong><br>
                                Users: <span id="userCount">0</span> | 
                                Requisitions: <span id="reqCount">0</span> | 
                                Vendors: <span id="vendorCount">0</span>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
</div>

<!-- Redirect Approver Modal -->
<div class="modal fade" id="redirectModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Redirect Requisition</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="redirectReqId">
                <div class="mb-3">
                    <label class="form-label">New Approver</label>
                    <select class="form-control" id="redirectApprover"></select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Reason for Redirect</label>
                    <textarea class="form-control" id="redirectReason" rows="3"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="confirmRedirect()">Redirect</button>
            </div>
        </div>
    </div>
</div>

<script>
// ===== THEME MANAGEMENT =====
function toggleTheme() {
    const body = document.body;
    const themeIcon = document.getElementById('themeIcon');
    
    if (body.classList.contains('light-mode')) {
        // Switch to dark mode
        body.classList.remove('light-mode');
        body.classList.add('dark-mode');
        themeIcon.textContent = '‚òÄÔ∏è';
        saveToLocalStorage('theme', 'dark');
        console.log('Switched to dark mode');
    } else {
        // Switch to light mode
        body.classList.remove('dark-mode');
        body.classList.add('light-mode');
        themeIcon.textContent = 'üåô';
        saveToLocalStorage('theme', 'light');
        console.log('Switched to light mode');
    }
}

function initializeTheme() {
    const savedTheme = loadFromLocalStorage('theme', 'light');
    const body = document.body;
    const themeIcon = document.getElementById('themeIcon');
    
    if (savedTheme === 'dark') {
        body.classList.add('dark-mode');
        themeIcon.textContent = '‚òÄÔ∏è';
    } else {
        body.classList.add('light-mode');
        themeIcon.textContent = 'üåô';
    }
    
    console.log('Theme initialized:', savedTheme);
}

// ===== LOCAL STORAGE FUNCTIONS =====
function saveToLocalStorage(key, data) {
    try {
        localStorage.setItem(key, JSON.stringify(data));
        return true;
    } catch (e) {
        console.error('Error saving to localStorage:', e);
        return false;
    }
}

function loadFromLocalStorage(key, defaultValue) {
    try {
        const data = localStorage.getItem(key);
        return data ? JSON.parse(data) : defaultValue;
    } catch (e) {
        console.error('Error loading from localStorage:', e);
        return defaultValue;
    }
}

function clearAllData() {
    if (confirm('Are you sure you want to clear ALL data? This cannot be undone!')) {
        try {
            localStorage.clear();
            location.reload();
        } catch (e) {
            console.error('Error clearing localStorage:', e);
        }
    }
}

// ===== DATA STORAGE =====
let currentUser = null;
let requisitionCounter = loadFromLocalStorage('requisitionCounter', 1);

const defaultDepartments = [
    { name: 'Engineering', accountCode: 'ENG003', budget: 100000 },
    { name: 'Finance', accountCode: 'FIN002', budget: 75000 },
    { name: 'Sales', accountCode: 'SLM001', budget: 80000 },
    { name: 'IT', accountCode: 'IT004', budget: 60000 },
    { name: 'HR', accountCode: 'HR005', budget: 50000 },
    { name: 'Executive', accountCode: 'EXE001', budget: 150000 }
];

const defaultUsers = [
    { id: 1, name: 'System Admin', username: 'admin', password: 'admin123', role: 'admin', department: 'Admin', hod: null },
    { id: 2, name: 'Ndhlovu, Kanyembo', username: 'kndhlovu', password: 'pass123', role: 'md', department: 'Executive', hod: null },
    { id: 3, name: 'Mbunda, Haggai', username: 'Hmbunda', password: 'pass123', role: 'hod', department: 'IT', hod: null },
    { id: 4, name: 'Banda, Anne', username: 'abanda', password: 'pass123', role: 'finance_manager', department: 'Finance', hod: null },
    { id: 5, name: 'Munthali, Joe', username: 'jmunthali', password: 'pass123', role: 'hod', department: 'Engineering', hod: null },
    { id: 6, name: 'Shebele, Moses', username: 'mshebele', password: 'pass123', role: 'hod', department: 'Sales', hod: null },
    { id: 7, name: 'Nanyangwe, Annie', username: 'ananyangwe', password: 'pass123', role: 'initiator', department: 'Finance', hod: 'abanda' },
    { id: 8, name: 'Nguni, Nashon', username: 'nnguni', password: 'pass123', role: 'initiator', department: 'Finance', hod: 'abanda' },
    { id: 9, name: 'Chabala, John', username: 'jchabala', password: 'pass123', role: 'initiator', department: 'Engineering', hod: 'jmunthali' },
    { id: 10, name: 'Kaluya, Justine', username: 'jkaluya', password: 'pass123', role: 'initiator', department: 'Engineering', hod: 'jmunthali' },
    { id: 11, name: 'Chishimba, Waden', username: 'wchishimba', password: 'pass123', role: 'initiator', department: 'Sales', hod: 'mshebele' },
    { id: 12, name: 'Zimba, Lina', username: 'lzimba', password: 'pass123', role: 'initiator', department: 'Sales', hod: 'mshebele' },
    { id: 13, name: 'Mwambazi, Larry', username: 'lmwambazi', password: 'pass123', role: 'hod', department: 'Engineering', hod: null },
    { id: 14, name: 'Chipwalu, Dickson', username: 'lchipwalu', password: 'pass123', role: 'initiator', department: 'Sales', hod: 'lmwambazi' },
    { id: 15, name: 'Chaponda, Hillary', username: 'hchaponda', password: 'pass123', role: 'initiator', department: 'Engineering', hod: 'lmwambazi' },
    { id: 16, name: 'Namute, Mbialesi', username: 'Mnamute', password: 'pass123', role: 'initiator', department: 'HR', hod: 'kndhlovu' },
    { id: 17, name: 'Phiri, Moses', username: 'Mphiri', password: 'pass123', role: 'initiator', department: 'Engineering', hod: 'lmwambazi' },
    { id: 18, name: 'Kalimba, Bernard', username: 'Bkalimba', password: 'pass123', role: 'initiator', department: 'Engineering', hod: 'lmwambazi' }
];

const defaultVendors = [
    'Bearing Man Group (BMG)', 'BOLLORE Logistics', 'BUILDERS WAREHOUSE INTERNATIONAL', 'BULK MACHINERY SOLUTION', 'CAMCO Equipment (Z) Limited', 
    'Champion Brothers', 'City Graphics Ltd', 'Computer King', 'Cozan Consulting CC', 'Damru Enterprises Limited', 'ECO Petroleum Ltd', 
    'EVEREST PAINTS', 'Face Investment SARL', 'Game Stores Zambia', 'GUARDIAN MOTORS', 'Horn Afric Oryx', 'JJ ERASMUS - Mapalo', 
    'Kanyanga Service Station', 'Lake Petroleum Ltd', 'Makro SA', 'Microsoft', 'MIST GARDENS', 'Mount Meru (Z) Ltd', 'Musapas Farm Ltd', 
    'Neelkanth Filling Station', 'Omnilyne Zambia Ltd', 'Oryx Energies', 'Palian Pty Ltd', 'PETCOM ZAMBIA LTD', 'Petroda', 'PICK N PAY', 
    'Poundstretcher Zambia Ltd', 'Power Tools Logistics Limited', 'PROTEA HOTEL', 'SES Specialty Emergency Services', 'SGC Investments', 
    'Spectra Oil', 'Sundry Supplier', 'Tectimas Engineering Services (Fire)', 'Torktek Ltd', 'Virtual Gifts South Africa', 'ZRA', 
    'Dynatech Pumps PTE. LTD.', 'Mifflin Trading Limited', 'MD Services', 'Kugula Tyres', 'Prime Edge Solutions', 'Thida Hardware', 
    'Zambia Red Cross Society', 'Umart Engineering Limited', 'The University of Zambia', 'Greendoor Group (Pty) Ltd', 'WILO Pumps SA (Pty) Ltd',
    'Bombay Ltd t/a Artisan Trading', 'MANCOSA', 'Freight Africa', 'KSB Manufacturing Netherlands BV', 'Brehnor Trading (Pty) Ltd',
    'AGRIPLAS Pty. Ltd', 'FCS Holdings', 'Electromote (PTY) LTD', 'PM Technology (PM S.r.l)', 'PRECISION METERS (PTY) LTD', 'RNJ Exports cc',
    'KSB Valves (Changzhou) Co., Ltd.', 'Zambian Irritech Ltd', 'Ansultech Fire Systems Ltd', 'Sulzer Zambia Limited', 'Fextec Enterprises Limited',
    'CRENSHAW INVESTMENT LIMITED', 'Martin House Trust School Limited', 'Chaminuka Lodge', 'Mutende Mining Supply SARL', 'Logwin Air & Ocean SA Ltd',
    'AccTech Copperbelt', 'IRRIGATION UNLIMITED', 'KSB Middle East FZE', 'Minpac Logistics (EMEA) FZCO', 'AESSEAL HOLDINGS (PTY) LIMITED',
    'Pumps for Africa', 'SHIM STOCK METALS', 'Amandla Pump (Pty) Ltd', 'Custom Trailer', 'Franklin Electric SA', 'Heku Engineering Ltd',
    'ESSE Clearing Ltd', 'ROVATTI POMPE', 'Milton Roy Europe', 'ACDC Dynamics', 'Roadlink Freight (PTY) Ltd', 'Leipziger Messe International',
    'BOLT & ENGINEERING DISTRIBUTORS (GAUTENG) (PTY) LIMITED', 'Yoto Impex PVT Limited', 'AFRICAN ENGINEERING SERVICES LTD', 'Elcontrol Limited',
    'TRI-PUMP ZAMBIA', 'Franklin Electric (Z) Ltd', 'QI Logistics (Pty) Ltd QUAD', 'TeamViewer', 'WUXI TRUMY TRANSMISSION ENGINEERING CO.,LTD.',
    'Joseph Technicolour CC', 'TRANSDUCER TECHNOLOGY (PTY) LTD', 'WEG Africa Pty (Ltd)', 'C.R.I. PUMPS S.A (PTY) LTD', 'Groucom Contracts & Supplies Limited',
    'Wedd Enterprise', 'VANSAN SA', 'SUMPAS SU SISTEMLERI METAL ELEKTRIK SAN. VE TIC. A.S.', 'Global Roofing Solution (GRS)', 'KSB MIL Controls Limited',
    'Super Armature Winding Africa (Pty) Ltd', 'Musapas Properties Ltd', 'Far South Motors Zambia Limited', 'Andrea Machinists Ltd', 'ARROW BEARINGS LIMITED',
    'Berncu Motors Ltd', 'BL & D COPPERBELT LTD', 'C & B ENGINEERING LIMITED', 'CHAMWACA INVESTMENTS LIMITED', 'Copperbelt Autoworx Limited',
    'CP ENGINEERING LTD', 'Customised Clearing & Forwarding Ltd (CCF)', 'DAMACO CONTRACTORS LTD', 'Davis & Shirtliff Ltd', 'DHL International',
    'DSV Air & Sea Ltd', 'Eskayarts Ltd', 'HARD PIPING AND FITTINGS LIMITED', 'Jennings Enterprises', 'LIFTECH ZAMBIA', 'MACSTEEL ZAMBIA LIMITED',
    'Marsh Zambia Limited', 'Marthinusen & Coutts', 'Mercury Express', 'Natkos Distributor Ltd', 'Nemchem International',
    'Rekay\'s Farming & Building Suppliers Limited', 'Scamont & karlsons Mining Solutions (Z) Ltd', 'CFAO Mobility Zambia Limited',
    'Paulrams Construction Limited', 'Afunika Investments Limited', 'Hardware & Electrical Appliances Limited', 'Richbel Driving School',
    'Action Auto Limited', 'Imperial Motors Zambia Limited', 'Auto Care Limited', 'Upskill Corporate Training & Consultancy Ltd', 'AT Computers Limited',
    'Powerdrive Transmission Suppliers Limited', 'Juso Auto Spares Limited', 'Job Power Systems Limited', 'Max T Solutions', 'Zambezi Regal Limited',
    'Fred Chime Signwritings', 'Fulunyemba Embroidery', 'Zambian Open University', 'Reyjas Investment Limited', 'Gulani Technologies Limited',
    'Compuzone Limited', 'BEM Motors', 'Columbus Mckinnon Limited', 'Flex Pass Investments Limited', 'Kitwe City Council', 'Diesel-Electric Zambia Limited',
    'AFFIRM LOGISTICS GENERAL DEALERS', 'ORCA DECO ZAMBIA LTD', 'Fox Trucks & Equipment', 'Budah Hardware', 'Data Core Zambia Limited',
    'Furnishing World', 'E.C Security Hardware', 'Oliborn Engineering Limited', 'Lamased General Dealers', 'E & SK Technologies',
    'Chomu Enterprises Limited', 'Harthews Transport & General Dealers', 'Nizam Crusher Limited', 'Inspired Link Solutions Ltd',
    'Zachariah Pasikale Limited', 'TM Lubricants Zambia Limited', 'The Milford Lodge', 'Jayrex Engineering Services', 'Balmy Investments Ltd',
    'KALTIRE', 'Fair Devine Scientific Solutions Ltd', 'Kalulushi Bio Agro (Z) Ltd', 'Zambia Institute of Business & Industrial Practice Management Board',
    'INFINITY GRAPHICS SOLUTIONS LTD', 'Moba Hotel Convention Centre', 'Kwik-Fix Engineering Limited', 'C-G Zambia Limited', 'Kitwe Hardware Limited',
    'Tyre-King', 'SIZMWA Investments & General Dealers Limited', 'Edwin Kopeka T/A E.K Seats Repair', 'Portrade Enterprises Limited',
    'Minecon Safety Zambia Ltd', 'Casefu Investments Limited', 'Victorious Computer Solutions', 'Dackson Harrison Investments Limited',
    'HITEX INSULATION LIMITED', 'Noshels Enterprises', 'Challen Investment Limited', 'DEMAR ENGINEERING LTD', 'Sherbourne Farms Limited',
    'Record Engineering Ltd', 'David-Lan Engineering & Supplies Limited', 'MFI Document Solutions Limited', 'Uzzitech Technology Limited',
    'Enrom Engineering Limited', 'Mic & E Zambia Limited', 'R.A.M Technical Services Ltd.', 'First Choice Investments Limited',
    'The Copperbelt & Agricultural Show Society Ltd', 'Malick General Dealers & Distributors Ltd', 'Japan Auto Spares Limited',
    'MERSON PLUMBTECH HARDWARE & GENERAL SUPPLIERS LTD', 'Mutripa Enterprises Limited', 'ZAMM IMPORTS LTD', 'Poly Professionals',
    'BI NETWORKS', 'LIQUIDROCK', 'Wardens Enterprises Limited', 'On-Point Transport', 'Conforta SARL', 'Carrier Logistics',
    'TOTAL Zambia Limited', 'Afrityre Limited', 'Agrico (Pty) Ltd', 'Baobab College', 'BSi Steel Limited', 'Global Logistics Ltd',
    'HHE ZAMBIA LIMITED', 'IBIS GARDENS LIMITED', 'IMPERIAL PLASTICS LIMITED', 'KAZUMA PLASTICS LTD', 'Lamasat International Limited',
    'Micmar Investments Limited', 'MTN (Zambia) Limited', 'OG ELECTRICALS', 'Omega Risk Solutions', 'Reiz Real Estate Investments',
    'SARO AGRO INDUSTRIAL LTD', 'ZAMBIA PAINT MANUFACTURERS', 'New Horizon Printing Press', 'Tradebrands Import and Distribution Ltd',
    'Lechwe Express Logistics LTD', 'Prestige Bearing & Eng. Supplies Ltd', 'Beautiful Gate Enterprises', 'Ceva Logistics Zambia Limited',
    'Sunray Power Company Limited', 'Zambezi Polyplast Limited', 'Zambia Yellow Pages', 'Danitsa Investments Limited', 'CASSIA Consultancy Engineering',
    'Innovatia Cloud', 'Absolute Branding & Advertising', 'Compstat Limited', 'Discovery Freight & Logistics Limited', 'Formative Innovations Limited',
    'Pipe Master Zambia', 'MADINAWALA ENGINEERING', 'Sonar International Limited', 'Waterman Pump Systems Ltd', 'Coastal Hire',
    'African Pump Company', 'Southern Switchgear & Automation Ltd.', 'Polyflex Zambia Limited', 'Rooney\'s Hire Zambia Limited',
    'Tandem Trailer Tech', 'Inyangani Products Limited', 'Sbeity Computer Ltd', 'FREAMP Electrical Limited', 'BL&D Plant Hire & Sales Ltd',
    'Wesdom Valves and Fittings', 'Jachris Hardware & Electrical', 'Saja Construction Limited', 'Flo-Tek Pipes Irrigation Zambia Limited',
    'M\'Kango Golfview Hotel', 'Zeekomo Cash & Carry', 'Eagle Africa Tours (EAT) Limited', 'Offset Media', 'Airtel Networks Zambia Plc',
    'Hardware Mart', 'Noxxy Computers', 'DIGITAL OCEAN SOLUTIONS', 'Electrical Maintenance Lusaka Ltd', 'BZ Transporters', 'AUTOWORLD',
    'CAVEMAN AUTO LTD', 'SIAMIC SUPPLIERS', 'Mwanei IT Consultants', 'Diesel Civil Mining Ltd', 'FINECOP Zambia Limited',
    'Ajay Industrial Corporation Zambia Limited', 'SPOT ON CARGO LIMITED', 'Lifestyle Centre Furniture', 'Diesel-Electric Lusaka',
    'VICHI Auto Spares & Suppliers', 'Auto 1 Zambia Limited', 'Wansanje Travel & Tourism Institute', 'Manest Mechanics & Transport',
    'TS Tyre Services Limited', 'Lamasat Media Limited', 'MTS General Dealers Limited', 'Tadmor Enterprises Limited', 'Leviso Enterprises',
    'Cretech Engineering Limited', 'Green 2000', 'Swift Haul Logistics', 'Steel King', 'PROTON ELECTRO-CABLE', 'ZAMBOLTS LIMITED',
    'TECHONE ELECTRICAL & ENGINEERING LIMITED', 'Puma Energy Zambia PLC', 'Primo Hughes', 'Ascent Motors Zambia Ltd', 'Sanji Footwear Hub Ltd',
    'Qenn Cargo Limited', 'T-Four Investments Limited', 'OG Electricals [Kitwe Branch]', 'Liquid Intelligent Technologies',
    'DAB (Sandys Creations Garden)', 'Loxlak (Z) Limited', 'LUSAKA BEARINGS CENTRE T/A', 'Accudyne Industries India Pvt Ltd',
    'African Navigator Limited', 'SPRUCELAND TECHNOLOGIES GROUP LIMITED', 'Aqua Aura', 'East Rand Valves & Eng Supplies',
    'Nkasami Engineering Solutions Limited', 'Afrox Zambia Limited', 'Likavern Enterprises', 'Luron Business Solution', 'NEELKANTH CABLES LTD',
    'REDBACK STEEL & CONSTRUCTION LIMITED', 'TRANSTON ENTERPRISE', 'Cargo Management & Logistics (Z) Ltd (CML)', 'NAC2000 Corporation Limited',
    'Circle Transtra International', 'Mission Press', 'SHAKTI', 'Sterling Travel', 'RAMU\'S ENGINEERING & GENERAL DEALER',
    'Tesk South Africa (PTY) Ltd', 'The Zambian Farmer', 'Nissan Zambia', 'COPY GENERAL DEALERS', 'MILTON ROY AMERICA',
    'PriceWaterhouse Coopers (PwC)', 'PROGRESSIVE MEASUREMENT & CONTROL', 'NIST Control Systems CC', 'Powermite',
    'LOG Industrial Automation & Control', 'BUCO Honeydew', 'ZEST WEG GROUP AFRICA (PTY) LTD', 'MAXISU PUMP MOTOR A.S',
    'AA4C AUTOMOTIVE CO. LTD', 'Milton Roy Industrial Shanghai CO. LTD', 'Shenzhen MICNO Electric Co., Ltd', 'REELUKA INVESTMENTS LIMITED',
    'Agrinet', 'Fixturlaser South Africa (Pty) Ltd', 'FORKLIFT GUYS', 'PSA Technology Group pty Ltd', 'STAIRS INDUSTRIAL CO. LTD',
    'Asoe Hose Manufacturing Inc', 'Miltonroy India Private Limited', 'TIANJIN UNION VALVE Co. Ltd', 'VIRTUVIAS BRAND ARCHITECTS (PTY) LTD',
    'LJTT Engineering Limited', 'CRYSTALLINKS INNOVATIONS LIMITED', 'FedEx Express Zambia Ltd', 'MAKARIOS TECHNICAL SERVICES LIMITED',
    'MECHANICS FOR AFRICA', 'Night Sight Zambia Limited', 'North Safety Products', 'Shoprite', 'Smiling Solution Ltd',
    'United Chemolide Ind.', 'Zambia National Farmers Union (ZNFU)', 'Ezytrack'
].sort();

// Load data from localStorage or use defaults
let departments = loadFromLocalStorage('departments', defaultDepartments);
let users = loadFromLocalStorage('users', defaultUsers);
let vendors = loadFromLocalStorage('vendors', defaultVendors);
let requisitions = loadFromLocalStorage('requisitions', []);

// Initialize app on page load
window.addEventListener('DOMContentLoaded', function() {
    // Initialize theme first
    initializeTheme();
    
    console.log('App initialized. Data loaded from localStorage.');
    console.log('Users:', users.length);
    console.log('Requisitions:', requisitions.length);
    console.log('Vendors:', vendors.length);
    
    // Ensure Finance Manager and MD exist in the system
    if (!users.find(u => u.role === 'finance_manager')) {
        console.warn('No Finance Manager found. Approval workflow may not work properly.');
    }
    if (!users.find(u => u.role === 'md')) {
        console.warn('No Managing Director found. Approval workflow may not work properly.');
    }
});

// ===== UTILITY FUNCTIONS =====
function showAlert(message, type = 'success') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button>`;
    document.getElementById('alertContainer').appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 3000);
}

function formatCurrency(amount) {
    return 'ZMW ' + parseFloat(amount).toFixed(2);
}

function formatDate(dateString) {
    if (!dateString) return 'N/A';
    return new Date(dateString).toLocaleDateString();
}

function generateReqNumber() {
    // Get user's initials
    const nameParts = currentUser.name.split(/[\s,]+/).filter(part => part.length > 0);
    let initials = '';
    
    if (nameParts.length >= 2) {
        // Get first letter of first name and first letter of last name
        initials = nameParts[0].charAt(0).toUpperCase() + nameParts[nameParts.length - 1].charAt(0).toUpperCase();
    } else if (nameParts.length === 1) {
        // If only one name, use first two letters
        initials = nameParts[0].substring(0, 2).toUpperCase();
    } else {
        initials = 'XX';
    }
    
    // Get department abbreviation (first 3 letters)
    const deptAbbr = currentUser.department.substring(0, 3).toUpperCase();
    
    // Get full timestamp: YYYYMMDDHHmmss
    const now = new Date();
    const timestamp = 
        now.getFullYear() + 
        String(now.getMonth() + 1).padStart(2, '0') + 
        String(now.getDate()).padStart(2, '0') + 
        String(now.getHours()).padStart(2, '0') + 
        String(now.getMinutes()).padStart(2, '0') + 
        String(now.getSeconds()).padStart(2, '0');
    
    // Format: KSB-DEPT-INITIALS-TIMESTAMP
    const number = `KSB-${deptAbbr}-${initials}-${timestamp}`;
    
    return number;
}

// ===== LOGIN/LOGOUT =====
document.getElementById('loginForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const username = document.getElementById('loginUsername').value;
    const password = document.getElementById('loginPassword').value;
    
    const user = users.find(u => u.username === username && u.password === password);
    
    if (user) {
        currentUser = user;
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('appScreen').classList.remove('hidden');
        document.getElementById('currentUserDisplay').textContent = user.name;
        document.getElementById('currentDeptDisplay').textContent = user.department;
        
        // Show/hide menu items based on role - Admin Panel should ALWAYS show for admin
        document.getElementById('adminMenuItem').classList.remove('hidden');
        document.getElementById('allRequisitionsMenuItem').classList.remove('hidden');
        document.getElementById('budgetMenuItem').classList.remove('hidden');
        
        if (user.role !== 'admin' && user.role !== 'finance_manager' && user.role !== 'md' && user.role !== 'hod') {
            document.getElementById('budgetMenuItem').classList.add('hidden');
        }
        
        if (user.role !== 'admin') {
            document.getElementById('adminMenuItem').classList.add('hidden');
            document.getElementById('allRequisitionsMenuItem').classList.add('hidden');
        }
        
        console.log('Logged in as:', user.name, '- Role:', user.role);
        console.log('Budget menu access check:', user.role === 'admin' || user.role === 'finance_manager' || user.role === 'md' || user.role === 'hod');
        
        showScreen('dashboard');
    } else {
        showAlert('Invalid username or password', 'danger');
    }
});

function logout() {
    currentUser = null;
    document.getElementById('appScreen').classList.add('hidden');
    document.getElementById('loginScreen').classList.remove('hidden');
    document.getElementById('loginUsername').value = '';
    document.getElementById('loginPassword').value = '';
}

// ===== SCREEN NAVIGATION =====
function showScreen(screenName) {
    document.querySelectorAll('.content-screen').forEach(screen => {
        screen.classList.add('hidden');
    });
    
    document.getElementById(screenName + 'Screen').classList.remove('hidden');
    
    if (screenName === 'dashboard') loadDashboard();
    if (screenName === 'createRequisition') loadCreateForm();
    if (screenName === 'myRequisitions') loadMyRequisitions();
    if (screenName === 'allRequisitions') loadAllRequisitions();
    if (screenName === 'pendingApprovals') loadPendingApprovals();
    if (screenName === 'approvedRequisitions') loadApprovedRequisitions();
    if (screenName === 'budgets') loadBudgets();
    if (screenName === 'reports') loadReports();
    if (screenName === 'adminPanel') loadAdminPanel();
}

// ===== DASHBOARD =====
function loadDashboard() {
    // Get requisitions based on role
    let myReqs = [];
    
    if (currentUser.role === 'admin') {
        // Admin sees all requisitions
        myReqs = requisitions;
    } else if (currentUser.role === 'hod') {
        // HOD sees: 1) All requisitions from their department OR 2) Any requisitions specifically assigned to them (redirected)
        myReqs = requisitions.filter(r => 
            r.department === currentUser.department || 
            r.currentApprover === currentUser.username
        );
    } else if (currentUser.role === 'finance_manager' || currentUser.role === 'md') {
        // Finance Manager and MD see all requisitions
        myReqs = requisitions;
    } else {
        // Initiators see only their own requisitions
        myReqs = requisitions.filter(r => r.createdBy === currentUser.username);
    }
    
    // Update statistics based on role-filtered requisitions
    document.getElementById('statPending').textContent = myReqs.filter(r => r.status === 'PENDING').length;
    document.getElementById('statApproved').textContent = myReqs.filter(r => r.status === 'APPROVED').length;
    document.getElementById('statRejected').textContent = myReqs.filter(r => r.status === 'REJECTED').length;
    document.getElementById('statDrafts').textContent = myReqs.filter(r => r.status === 'DRAFT').length;
    
    // Pending approvals (for HODs, Finance Manager, MD and Admin)
    let pendingForApproval = [];
    
    if (currentUser.role === 'admin') {
        pendingForApproval = requisitions.filter(r => r.status === 'PENDING');
    } else if (currentUser.role === 'hod') {
        // HOD sees: 1) All pending from their department OR 2) Any pending specifically assigned to them (redirected from other departments)
        pendingForApproval = requisitions.filter(r => 
            r.status === 'PENDING' && 
            (r.department === currentUser.department || r.currentApprover === currentUser.username)
        );
        console.log('=== HOD DASHBOARD DEBUG ===');
        console.log('Current HOD:', currentUser.username);
        console.log('Department:', currentUser.department);
        console.log('All Pending Requisitions:', requisitions.filter(r => r.status === 'PENDING').map(r => ({
            number: r.number,
            department: r.department,
            currentApprover: r.currentApprover,
            stage: r.approvalStage
        })));
        console.log('Pending for this HOD:', pendingForApproval.map(r => ({
            number: r.number,
            department: r.department,
            currentApprover: r.currentApprover,
            matchesDept: r.department === currentUser.department,
            matchesApprover: r.currentApprover === currentUser.username
        })));
        console.log('=== END DASHBOARD DEBUG ===');
    } else if (currentUser.role === 'finance_manager') {
        pendingForApproval = requisitions.filter(r => r.status === 'PENDING');
    } else if (currentUser.role === 'md') {
        pendingForApproval = requisitions.filter(r => r.status === 'PENDING');
    }
    
    if (pendingForApproval.length > 0) {
        document.getElementById('pendingApprovalsCard').classList.remove('hidden');
        let html = '<table class="table"><thead><tr><th>Req #</th><th>Requestor</th><th>Dept</th><th>Description</th><th>Amount</th><th>Stage</th><th>Awaiting</th><th>Action</th></tr></thead><tbody>';
        pendingForApproval.forEach(req => {
            const user = users.find(u => u.username === req.createdBy);
            // Check if current user can review this specific requisition
            const canReview = currentUser.role === 'admin' ||
                            (req.approvalStage === 'HOD' && req.currentApprover === currentUser.username) ||
                            (req.approvalStage === 'FINANCE' && currentUser.role === 'finance_manager') ||
                            (req.approvalStage === 'MD' && currentUser.role === 'md');
            
            // Check if this was redirected to this user
            const isRedirected = req.redirectHistory && req.redirectHistory.length > 0 && 
                               req.currentApprover === currentUser.username &&
                               req.department !== currentUser.department;
            
            html += `<tr ${isRedirected ? 'class="table-warning"' : ''}>
                <td>${req.number}${isRedirected ? ' <span class="badge bg-warning text-dark">Redirected</span>' : ''}</td>
                <td>${user ? user.name : req.createdBy}</td>
                <td>${req.department}</td>
                <td>${req.description.substring(0, 30)}...</td>
                <td>${formatCurrency(req.totalCost)}</td>
                <td><span class="badge bg-info">${req.approvalStage}</span></td>
                <td class="small">${req.currentApproverName || 'N/A'}</td>
                <td>
                    ${canReview ? `<button class="btn btn-sm btn-primary" onclick="viewRequisition(${req.id})">Review</button>` : 
                                  `<button class="btn btn-sm btn-secondary" onclick="viewRequisition(${req.id})">View</button>`}
                </td>
            </tr>`;
        });
        html += '</tbody></table>';
        document.getElementById('dashboardPendingList').innerHTML = html;
    } else {
        document.getElementById('pendingApprovalsCard').classList.add('hidden');
    }
    
    // Recent requisitions - based on role
    let recentReqs = [];
    if (currentUser.role === 'admin') {
        recentReqs = requisitions.slice(-5).reverse();
    } else if (currentUser.role === 'hod') {
        // HOD sees requisitions from their department OR assigned to them
        recentReqs = requisitions.filter(r => 
            r.department === currentUser.department || 
            r.currentApprover === currentUser.username
        ).slice(-5).reverse();
    } else if (currentUser.role === 'finance_manager' || currentUser.role === 'md') {
        recentReqs = requisitions.slice(-5).reverse();
    } else {
        recentReqs = myReqs.slice(-5).reverse();
    }
    
    let html = '<table class="table"><thead><tr><th>Req #</th><th>Requestor</th><th>Description</th><th>Amount</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
    if (recentReqs.length === 0) {
        html += '<tr><td colspan="7" class="text-center">No requisitions yet. <a href="#" onclick="showScreen(\'createRequisition\')">Create one now</a></td></tr>';
    } else {
        recentReqs.forEach(req => {
            html += `<tr>
                <td><a href="#" onclick="viewRequisition(${req.id})">${req.number}</a></td>
                <td>${req.creatorName}</td>
                <td>${req.description.substring(0, 50)}...</td>
                <td>${formatCurrency(req.totalCost)}</td>
                <td><span class="badge badge-${req.status.toLowerCase()}">${req.status}</span></td>
                <td>${formatDate(req.createdAt)}</td>
                <td class="action-buttons">
                    ${req.status === 'DRAFT' && req.createdBy === currentUser.username ? `<button class="btn btn-sm btn-primary" onclick="editRequisition(${req.id})">Edit</button>` : ''}
                    ${(req.status === 'APPROVED' || req.status === 'REJECTED') ? `<button class="btn btn-sm btn-info" onclick="downloadRequisitionPDF(${req.id})">PDF</button>` : ''}
                </td>
            </tr>`;
        });
    }
    html += '</tbody></table>';
    document.getElementById('dashboardRecentList').innerHTML = html;
}

// ===== CREATE/EDIT REQUISITION =====
let itemRowCounter = 0;

function loadCreateForm() {
    const dept = departments.find(d => d.name === currentUser.department);
    document.getElementById('reqDepartment').value = currentUser.department;
    document.getElementById('reqAccountCode').value = dept ? dept.accountCode : '';
    
    // Set minimum date to today for Required By field
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('reqRequiredBy').setAttribute('min', today);
    
    // Load vendors
    let vendorHtml = '<option value="">Select Vendor</option>';
    vendors.forEach(vendor => {
        vendorHtml += `<option value="${vendor}">${vendor}</option>`;
    });
    document.getElementById('reqVendor').innerHTML = vendorHtml;
    
    // Show budget status for initiators
    if (dept && currentUser.role === 'initiator') {
        const spent = requisitions
            .filter(r => r.department === currentUser.department && r.status === 'APPROVED')
            .reduce((sum, r) => sum + r.totalCost, 0);
        const available = dept.budget - spent;
        const percentage = dept.budget > 0 ? ((spent / dept.budget) * 100).toFixed(1) : 0;
        
        let budgetAlert = '';
        if (percentage >= 100) {
            budgetAlert = `<div class="alert alert-danger">
                <strong>‚ö†Ô∏è Budget Exceeded!</strong> Your department has exceeded its budget. 
                Budget: ${formatCurrency(dept.budget)} | Spent: ${formatCurrency(spent)} | Available: ${formatCurrency(available)}
            </div>`;
        } else if (percentage >= 80) {
            budgetAlert = `<div class="alert alert-warning">
                <strong>‚ö†Ô∏è Budget Alert!</strong> Your department has used ${percentage}% of its budget. 
                Budget: ${formatCurrency(dept.budget)} | Available: ${formatCurrency(available)}
            </div>`;
        } else {
            budgetAlert = `<div class="alert alert-info">
                <strong>Budget Status:</strong> ${percentage}% consumed | Available: ${formatCurrency(available)} of ${formatCurrency(dept.budget)}
            </div>`;
        }
        
        const formCard = document.querySelector('#createRequisitionScreen .card-body');
        if (formCard) {
            const existingAlert = formCard.querySelector('.budget-status-alert');
            if (existingAlert) existingAlert.remove();
            
            const alertDiv = document.createElement('div');
            alertDiv.className = 'budget-status-alert';
            alertDiv.innerHTML = budgetAlert;
            formCard.insertBefore(alertDiv, formCard.firstChild);
        }
    }
    
    // Reset form if not editing
    const editId = document.getElementById('editReqId').value;
    if (!editId) {
        document.getElementById('requisitionForm').reset();
        document.getElementById('reqDepartment').value = currentUser.department;
        document.getElementById('reqAccountCode').value = dept ? dept.accountCode : '';
        document.getElementById('reqFormTitle').textContent = 'Create New Requisition';
        
        // Clear items table and add first row
        const tbody = document.getElementById('itemsTableBody');
        if (tbody) {
            tbody.innerHTML = '';
            itemRowCounter = 0;
            addItemRow();
        }
    }
}

function addItemRow() {
    const tbody = document.getElementById('itemsTableBody');
    if (!tbody) {
        console.error('Items table body not found');
        return;
    }
    
    const rowCount = tbody.querySelectorAll('tr').length;
    
    if (rowCount >= 30) {
        showAlert('Maximum 30 items allowed per requisition', 'warning');
        return;
    }
    
    itemRowCounter++;
    const rowId = `item-row-${itemRowCounter}`;
    
    const row = document.createElement('tr');
    row.id = rowId;
    row.innerHTML = `
        <td>${rowCount + 1}</td>
        <td><textarea class="form-control item-description" rows="2" required></textarea></td>
        <td><input type="number" class="form-control item-quantity" min="1" value="1" required></td>
        <td><input type="number" class="form-control item-unit-cost" step="0.01" min="0" required></td>
        <td><input type="text" class="form-control item-total" value="ZMW 0.00" readonly></td>
        <td><button type="button" class="btn btn-sm btn-danger" onclick="removeItemRow('${rowId}')">Remove</button></td>
    `;
    
    tbody.appendChild(row);
    
    // Add event listeners to newly added row
    const newRow = document.getElementById(rowId);
    if (newRow) {
        newRow.querySelector('.item-quantity').addEventListener('input', function() {
            calculateItemTotal(rowId);
        });
        newRow.querySelector('.item-unit-cost').addEventListener('input', function() {
            calculateItemTotal(rowId);
        });
    }
    
    updateItemNumbers();
    console.log('Added item row:', rowId, 'Total rows:', tbody.querySelectorAll('tr').length);
}

function removeItemRow(rowId) {
    const row = document.getElementById(rowId);
    if (row) {
        const tbody = document.getElementById('itemsTableBody');
        const rowCount = tbody.querySelectorAll('tr').length;
        
        if (rowCount <= 1) {
            showAlert('At least one item is required', 'warning');
            return;
        }
        
        row.remove();
        updateItemNumbers();
        calculateGrandTotal();
        console.log('Removed row:', rowId);
    }
}

function updateItemNumbers() {
    const tbody = document.getElementById('itemsTableBody');
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll('tr');
    rows.forEach((row, index) => {
        const firstCell = row.querySelector('td:first-child');
        if (firstCell) {
            firstCell.textContent = index + 1;
        }
    });
}

function calculateItemTotal(rowId) {
    const row = document.getElementById(rowId);
    if (!row) return;
    
    const quantityInput = row.querySelector('.item-quantity');
    const unitCostInput = row.querySelector('.item-unit-cost');
    const totalInput = row.querySelector('.item-total');
    
    if (!quantityInput || !unitCostInput || !totalInput) return;
    
    const quantity = parseFloat(quantityInput.value) || 0;
    const unitCost = parseFloat(unitCostInput.value) || 0;
    const total = quantity * unitCost;
    
    totalInput.value = formatCurrency(total);
    calculateGrandTotal();
}

function calculateGrandTotal() {
    const tbody = document.getElementById('itemsTableBody');
    if (!tbody) return;
    
    const rows = tbody.querySelectorAll('tr');
    let grandTotal = 0;
    
    rows.forEach(row => {
        const quantity = parseFloat(row.querySelector('.item-quantity').value) || 0;
        const unitCost = parseFloat(row.querySelector('.item-unit-cost').value) || 0;
        grandTotal += quantity * unitCost;
    });
    
    const grandTotalElement = document.getElementById('grandTotal');
    if (grandTotalElement) {
        grandTotalElement.textContent = formatCurrency(grandTotal);
    }
}

function editRequisition(reqId) {
    const req = requisitions.find(r => r.id === reqId);
    if (!req) {
        showAlert('Requisition not found', 'danger');
        return;
    }
    
    if (req.status !== 'DRAFT') {
        showAlert('Only draft requisitions can be edited', 'warning');
        return;
    }
    
    // Show the form
    showScreen('createRequisition');
    
    // Wait a bit for screen to load, then populate
    setTimeout(() => {
        document.getElementById('reqFormTitle').textContent = 'Edit Draft Requisition';
        document.getElementById('editReqId').value = req.id;
        
        // Populate form fields
        const dept = departments.find(d => d.name === req.department);
        document.getElementById('reqDepartment').value = req.department;
        document.getElementById('reqAccountCode').value = req.accountCode;
        
        // Load vendors first
        let vendorHtml = '<option value="">Select Vendor</option>';
        vendors.forEach(vendor => {
            vendorHtml += `<option value="${vendor}">${vendor}</option>`;
        });
        document.getElementById('reqVendor').innerHTML = vendorHtml;
        
        // Set the selected vendor
        document.getElementById('reqVendor').value = req.vendor;
        document.getElementById('reqUrgency').value = req.urgency;
        document.getElementById('reqLocation').value = req.deliveryLocation;
        document.getElementById('reqRequiredBy').value = req.requiredBy || '';
        document.getElementById('reqJustification').value = req.justification;
        
        // Load items
        document.getElementById('itemsTableBody').innerHTML = '';
        itemRowCounter = 0;
        
        if (req.items && req.items.length > 0) {
            req.items.forEach(item => {
                itemRowCounter++;
                const rowId = `item-row-${itemRowCounter}`;
                const tbody = document.getElementById('itemsTableBody');
                
                const row = document.createElement('tr');
                row.id = rowId;
                row.innerHTML = `
                    <td>${itemRowCounter}</td>
                    <td><textarea class="form-control item-description" rows="2" required>${item.description}</textarea></td>
                    <td><input type="number" class="form-control item-quantity" min="1" value="${item.quantity}" required onchange="calculateItemTotal('${rowId}')"></td>
                    <td><input type="number" class="form-control item-unit-cost" step="0.01" min="0" value="${item.unitCost}" required onchange="calculateItemTotal('${rowId}')"></td>
                    <td><input type="text" class="form-control item-total" readonly value="${formatCurrency(item.quantity * item.unitCost)}"></td>
                    <td><button type="button" class="btn btn-sm btn-danger" onclick="removeItemRow('${rowId}')">‚úï</button></td>
                `;
                tbody.appendChild(row);
            });
            calculateGrandTotal();
        } else {
            // For old requisitions without items array, create one item from old fields
            addItemRow();
            const firstRow = document.querySelector('#itemsTableBody tr');
            if (firstRow && req.description) {
                firstRow.querySelector('.item-description').value = req.description;
                firstRow.querySelector('.item-quantity').value = req.quantity || 1;
                firstRow.querySelector('.item-unit-cost').value = req.unitCost || 0;
                calculateItemTotal(firstRow.id);
            }
        }
    }, 100);
}

function cancelEdit() {
    document.getElementById('editReqId').value = '';
    document.getElementById('requisitionForm').reset();
    document.getElementById('itemsTableBody').innerHTML = '';
    itemRowCounter = 0;
    showScreen('dashboard');
}

document.getElementById('requisitionForm').addEventListener('submit', function(e) {
    e.preventDefault();
    saveRequisition('PENDING');
});

function saveDraft() {
    saveRequisition('DRAFT');
}

function saveRequisition(status) {
    // Collect items from table
    const tbody = document.getElementById('itemsTableBody');
    const rows = tbody.querySelectorAll('tr');
    
    if (rows.length === 0) {
        showAlert('Please add at least one item', 'warning');
        return;
    }
    
    const items = [];
    let hasEmptyFields = false;
    
    rows.forEach(row => {
        const description = row.querySelector('.item-description').value.trim();
        const quantity = parseFloat(row.querySelector('.item-quantity').value);
        const unitCost = parseFloat(row.querySelector('.item-unit-cost').value);
        
        if (!description || !quantity || !unitCost) {
            hasEmptyFields = true;
        } else {
            items.push({
                description: description,
                quantity: quantity,
                unitCost: unitCost,
                total: quantity * unitCost
            });
        }
    });
    
    if (hasEmptyFields && status === 'PENDING') {
        showAlert('Please fill all item fields before submitting', 'warning');
        return;
    }
    
    // Calculate total cost
    const totalCost = items.reduce((sum, item) => sum + item.total, 0);
    
    const dept = departments.find(d => d.name === currentUser.department);
    const editId = document.getElementById('editReqId').value;
    
    // Get HOD approver
    const hodUser = users.find(u => u.username === currentUser.hod);
    // Get Finance Manager
    const financeManager = users.find(u => u.role === 'finance_manager');
    // Get MD
    const md = users.find(u => u.role === 'md');
    
    // Create description summary for display
    const descriptionSummary = items.length === 1 
        ? items[0].description 
        : `${items.length} items: ${items[0].description}${items.length > 1 ? ', ...' : ''}`;
    
    if (editId) {
        // Update existing draft
        const req = requisitions.find(r => r.id === parseInt(editId));
        req.vendor = document.getElementById('reqVendor').value;
        req.items = items;
        req.description = descriptionSummary; // For backward compatibility and display
        req.totalCost = totalCost;
        req.justification = document.getElementById('reqJustification').value;
        req.urgency = document.getElementById('reqUrgency').value;
        req.deliveryLocation = document.getElementById('reqLocation').value;
        req.requiredBy = document.getElementById('reqRequiredBy').value;
        req.status = status;
        
        if (status === 'PENDING') {
            req.approvalStage = 'HOD';
            req.currentApprover = hodUser ? hodUser.username : null;
            req.currentApproverName = hodUser ? hodUser.name : null;
        }
        
        showAlert(status === 'PENDING' ? 'Requisition submitted for approval!' : 'Draft updated.');
        document.getElementById('editReqId').value = '';
    } else {
        // Create new requisition
        const requisition = {
            id: Date.now(),
            number: generateReqNumber(),
            createdBy: currentUser.username,
            creatorName: currentUser.name,
            department: currentUser.department,
            accountCode: dept ? dept.accountCode : '',
            vendor: document.getElementById('reqVendor').value,
            items: items,
            description: descriptionSummary, // For backward compatibility and display
            totalCost: totalCost,
            justification: document.getElementById('reqJustification').value,
            urgency: document.getElementById('reqUrgency').value,
            deliveryLocation: document.getElementById('reqLocation').value,
            requiredBy: document.getElementById('reqRequiredBy').value,
            status: status,
            
            // Multi-level approval fields
            approvalStage: status === 'PENDING' ? 'HOD' : null,
            currentApprover: status === 'PENDING' ? (hodUser ? hodUser.username : null) : null,
            currentApproverName: status === 'PENDING' ? (hodUser ? hodUser.name : null) : null,
            
            // Approval history
            hodApprover: hodUser ? hodUser.username : null,
            hodApproverName: hodUser ? hodUser.name : null,
            hodApprovedAt: null,
            hodComments: '',
            
            financeApprover: financeManager ? financeManager.username : null,
            financeApproverName: financeManager ? financeManager.name : null,
            financeApprovedAt: null,
            financeComments: '',
            
            mdApprover: md ? md.username : null,
            mdApproverName: md ? md.name : null,
            mdApprovedAt: null,
            mdComments: '',
            
            createdAt: new Date().toISOString(),
            finalApprovedBy: null,
            finalApprovedAt: null,
            rejectedBy: null,
            rejectedAt: null,
            rejectionComments: ''
        };
        
        requisitions.push(requisition);
        showAlert(status === 'PENDING' ? 'Requisition submitted for HOD approval!' : 'Requisition saved as draft.');
    }
    
    // Save to localStorage
    saveToLocalStorage('requisitions', requisitions);
    
    // Reset form
    document.getElementById('itemsTableBody').innerHTML = '';
    itemRowCounter = 0;
    
    showScreen('dashboard');
}

// ===== MY REQUISITIONS =====
let currentFilter = 'ALL';

function loadMyRequisitions() {
    filterRequisitions(currentFilter);
}

function filterRequisitions(status) {
    currentFilter = status;
    const myReqs = requisitions.filter(r => r.createdBy === currentUser.username);
    const filtered = status === 'ALL' ? myReqs : myReqs.filter(r => r.status === status);
    
    let html = '<table class="table"><thead><tr><th>Req #</th><th>Description</th><th>Vendor</th><th>Amount</th><th>Status</th><th>Created</th><th>Actions</th></tr></thead><tbody>';
    
    if (filtered.length === 0) {
        html += '<tr><td colspan="7" class="text-center">No requisitions found.</td></tr>';
    } else {
        filtered.forEach(req => {
            html += `<tr>
                <td><a href="#" onclick="viewRequisition(${req.id})">${req.number}</a></td>
                <td>${req.description.substring(0, 40)}...</td>
                <td>${req.vendor || 'N/A'}</td>
                <td>${formatCurrency(req.totalCost)}</td>
                <td><span class="badge badge-${req.status.toLowerCase()}">${req.status}</span></td>
                <td>${formatDate(req.createdAt)}</td>
                <td class="action-buttons">
                    ${req.status === 'DRAFT' ? `<button class="btn btn-sm btn-primary" onclick="editRequisition(${req.id})">Edit</button>` : ''}
                    ${(req.status === 'APPROVED' || req.status === 'REJECTED') ? `<button class="btn btn-sm btn-info" onclick="downloadRequisitionPDF(${req.id})">PDF</button>` : ''}
                </td>
            </tr>`;
        });
    }
    
    html += '</tbody></table>';
    document.getElementById('myRequisitionsList').innerHTML = html;
}

// ===== ALL REQUISITIONS (ADMIN) =====
let allReqFilter = 'ALL';

function loadAllRequisitions() {
    filterAllRequisitions(allReqFilter);
}

function filterAllRequisitions(status) {
    allReqFilter = status;
    const filtered = status === 'ALL' ? requisitions : requisitions.filter(r => r.status === status);
    
    let html = '<table class="table"><thead><tr><th>Req #</th><th>Requestor</th><th>Department</th><th>Description</th><th>Amount</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
    
    if (filtered.length === 0) {
        html += '<tr><td colspan="7" class="text-center">No requisitions found.</td></tr>';
    } else {
        filtered.forEach(req => {
            html += `<tr>
                <td><a href="#" onclick="viewRequisition(${req.id})">${req.number}</a></td>
                <td>${req.creatorName}</td>
                <td>${req.department}</td>
                <td>${req.description.substring(0, 30)}...</td>
                <td>${formatCurrency(req.totalCost)}</td>
                <td><span class="badge badge-${req.status.toLowerCase()}">${req.status}</span></td>
                <td class="action-buttons">
                    ${req.status === 'PENDING' ? `<button class="btn btn-sm btn-warning" onclick="showRedirectModal(${req.id})">Redirect</button>` : ''}
                    ${(req.status === 'APPROVED' || req.status === 'REJECTED') ? `<button class="btn btn-sm btn-info" onclick="downloadRequisitionPDF(${req.id})">PDF</button>` : ''}
                </td>
            </tr>`;
        });
    }
    
    html += '</tbody></table>';
    document.getElementById('allRequisitionsList').innerHTML = html;
}

// ===== REQUISITION DETAIL =====
function viewRequisition(reqId) {
    const req = requisitions.find(r => r.id === reqId);
    if (!req) return;
    
    // Check permissions
    const canView = currentUser.role === 'admin' || 
                    req.createdBy === currentUser.username || 
                    req.currentApprover === currentUser.username ||
                    (currentUser.role === 'finance_manager' && req.approvalStage === 'FINANCE') ||
                    (currentUser.role === 'md' && req.approvalStage === 'MD');
    
    if (!canView) {
        showAlert('You do not have permission to view this requisition', 'danger');
        return;
    }
    
    // Determine if current user can approve at this stage
    const canApprove = req.status === 'PENDING' && (
        currentUser.role === 'admin' ||
        (req.approvalStage === 'HOD' && req.currentApprover === currentUser.username) ||
        (req.approvalStage === 'FINANCE' && currentUser.role === 'finance_manager') ||
        (req.approvalStage === 'MD' && currentUser.role === 'md')
    );
    
    // Build approval history
    let approvalHistory = '';
    if (req.hodApprovedAt || req.financeApprovedAt || req.mdApprovedAt || req.rejectedAt || (req.redirectHistory && req.redirectHistory.length > 0)) {
        approvalHistory = '<div class="mt-3"><h5>Approval History</h5><div class="timeline">';
        
        // Show redirect history first if exists
        if (req.redirectHistory && req.redirectHistory.length > 0) {
            req.redirectHistory.forEach(redirect => {
                approvalHistory += `<div class="alert alert-warning">
                    <strong>‚Ü™ Redirected:</strong> Redirected to ${redirect.toName} by ${redirect.redirectedBy} on ${formatDate(redirect.date)}
                    ${redirect.reason ? `<br><em>Reason: ${redirect.reason}</em>` : ''}
                </div>`;
            });
        }
        
        if (req.hodApprovedAt) {
            approvalHistory += `<div class="alert alert-success">
                <strong>‚úì HOD Approval:</strong> Approved by ${req.hodApproverName} on ${formatDate(req.hodApprovedAt)}
                ${req.hodComments ? `<br><em>Comments: ${req.hodComments}</em>` : ''}
            </div>`;
        }
        
        if (req.financeApprovedAt) {
            approvalHistory += `<div class="alert alert-success">
                <strong>‚úì Finance Manager Approval:</strong> Approved by ${req.financeApproverName} on ${formatDate(req.financeApprovedAt)}
                ${req.financeComments ? `<br><em>Comments: ${req.financeComments}</em>` : ''}
            </div>`;
        }
        
        if (req.mdApprovedAt) {
            approvalHistory += `<div class="alert alert-success">
                <strong>‚úì MD Approval:</strong> Approved by ${req.mdApproverName} on ${formatDate(req.mdApprovedAt)}
                ${req.mdComments ? `<br><em>Comments: ${req.mdComments}</em>` : ''}
            </div>`;
        }
        
        if (req.rejectedAt) {
            approvalHistory += `<div class="alert alert-danger">
                <strong>‚úó Rejected:</strong> Rejected by ${req.rejectedBy} on ${formatDate(req.rejectedAt)}
                ${req.rejectionComments ? `<br><em>Reason: ${req.rejectionComments}</em>` : ''}
            </div>`;
        }
        
        approvalHistory += '</div></div>';
    }
    
    // Current approval stage indicator
    let stageIndicator = '';
    if (req.status === 'PENDING') {
        stageIndicator = `<div class="alert alert-warning">
            <strong>Current Stage:</strong> Awaiting ${req.approvalStage} approval from ${req.currentApproverName}
        </div>`;
    }
    
    let html = `
        <div class="d-flex justify-content-between align-items-center">
            <h1>Requisition ${req.number}</h1>
            <div>
                <span class="badge badge-${req.status.toLowerCase()} fs-5">${req.status}</span>
                ${(req.status === 'APPROVED' || req.status === 'REJECTED') ? `<button class="btn btn-sm btn-info ms-2" onclick="downloadRequisitionPDF(${req.id})">Download PDF</button>` : ''}
            </div>
        </div>
        
        ${stageIndicator}
        
        <div class="card mt-4">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>Purchase Details</h5>
                        <table class="table table-borderless">
                            <tr><td><strong>Vendor:</strong></td><td>${req.vendor || 'Not specified'}</td></tr>
                            <tr><td><strong>Delivery Location:</strong></td><td>${req.deliveryLocation}</td></tr>
                            <tr><td><strong>Total Cost:</strong></td><td><strong>${formatCurrency(req.totalCost)}</strong></td></tr>
                        </table>
                        
                        <h5 class="mt-3">Items</h5>
                        <div class="table-responsive">
                            <table class="table table-sm table-bordered">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>Description</th>
                                        <th>Qty</th>
                                        <th>Unit Cost</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${req.items && req.items.length > 0 ? 
                                        req.items.map((item, index) => `
                                            <tr>
                                                <td>${index + 1}</td>
                                                <td>${item.description}</td>
                                                <td>${item.quantity}</td>
                                                <td>${formatCurrency(item.unitCost)}</td>
                                                <td>${formatCurrency(item.total)}</td>
                                            </tr>
                                        `).join('') :
                                        `<tr>
                                            <td>1</td>
                                            <td>${req.description}</td>
                                            <td>${req.quantity || 1}</td>
                                            <td>${formatCurrency(req.unitCost || 0)}</td>
                                            <td>${formatCurrency(req.totalCost)}</td>
                                        </tr>`
                                    }
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="4" class="text-end">Grand Total:</th>
                                        <th>${formatCurrency(req.totalCost)}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <h5>Request Information</h5>
                        <table class="table table-borderless">
                            <tr><td><strong>Department:</strong></td><td>${req.department}</td></tr>
                            <tr><td><strong>Account Code:</strong></td><td>${req.accountCode}</td></tr>
                            <tr><td><strong>Requested by:</strong></td><td>${req.creatorName}</td></tr>
                            <tr><td><strong>Created:</strong></td><td>${formatDate(req.createdAt)}</td></tr>
                            <tr><td><strong>Urgency:</strong></td><td>${req.urgency}</td></tr>
                            <tr><td><strong>Required by:</strong></td><td>${formatDate(req.requiredBy)}</td></tr>
                        </table>
                    </div>
                </div>
                
                <div class="mt-3">
                    <h5>Justification</h5>
                    <p>${req.justification}</p>
                </div>
                
                ${approvalHistory}
                
                <div class="mt-4">
                    ${canApprove ? `<button class="btn btn-primary" onclick="showApprovalForm(${req.id})">Review & Approve</button>` : ''}
                    ${currentUser.role === 'admin' && req.status === 'PENDING' ? `<button class="btn btn-warning" onclick="showRedirectModal(${req.id})">Redirect Approver</button>` : ''}
                    ${req.status === 'DRAFT' && req.createdBy === currentUser.username ? `<button class="btn btn-success" onclick="editRequisition(${req.id})">Edit Draft</button>` : ''}
                    <button class="btn btn-outline-secondary" onclick="showScreen('dashboard')">Back to Dashboard</button>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('requisitionDetailContent').innerHTML = html;
    showScreen('requisitionDetail');
}

function showApprovalForm(reqId) {
    const req = requisitions.find(r => r.id === reqId);
    if (!req) return;
    
    let html = `
        <h1>Review Requisition ${req.number}</h1>
        
        <div class="card mt-4">
            <div class="card-body">
                <h5>Purchase Summary</h5>
                <ul>
                    <li><strong>Requestor:</strong> ${req.creatorName}</li>
                    <li><strong>Department:</strong> ${req.department} (${req.accountCode})</li>
                    <li><strong>Vendor:</strong> ${req.vendor}</li>
                    <li><strong>Item:</strong> ${req.description}</li>
                    <li><strong>Total Cost:</strong> ${formatCurrency(req.totalCost)}</li>
                    <li><strong>Delivery Location:</strong> ${req.deliveryLocation}</li>
                    <li><strong>Justification:</strong> ${req.justification}</li>
                </ul>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-header bg-warning">
                <h5>Approval Decision</h5>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="approvalAction" id="approve" value="APPROVED" checked>
                        <label class="form-check-label" for="approve">Approve</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="radio" name="approvalAction" id="reject" value="REJECTED">
                        <label class="form-check-label" for="reject">Reject</label>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Comments (optional)</label>
                    <textarea class="form-control" id="approvalComments" rows="3"></textarea>
                </div>
                
                <button class="btn btn-primary" onclick="processApproval(${req.id})">Submit Decision</button>
                <button class="btn btn-outline-secondary" onclick="viewRequisition(${req.id})">Cancel</button>
            </div>
        </div>
    `;
    
    document.getElementById('requisitionDetailContent').innerHTML = html;
}

function processApproval(reqId) {
    const action = document.querySelector('input[name="approvalAction"]:checked').value;
    const comments = document.getElementById('approvalComments').value;
    
    const req = requisitions.find(r => r.id === reqId);
    if (!req) return;
    
    if (action === 'REJECTED') {
        // Reject the requisition
        req.status = 'REJECTED';
        req.rejectedBy = currentUser.name;
        req.rejectedAt = new Date().toISOString();
        req.rejectionComments = comments;
        showAlert('Requisition rejected.', 'warning');
        saveToLocalStorage('requisitions', requisitions);
        showScreen('pendingApprovals');
        return;
    }
    
    // Approve at current stage
    if (req.approvalStage === 'HOD') {
        req.hodApprovedAt = new Date().toISOString();
        req.hodComments = comments;
        
        // Move to Finance Manager
        const financeManager = users.find(u => u.role === 'finance_manager');
        req.approvalStage = 'FINANCE';
        req.currentApprover = financeManager ? financeManager.username : null;
        req.currentApproverName = financeManager ? financeManager.name : null;
        
        showAlert('HOD approval completed. Requisition forwarded to Finance Manager.');
        
    } else if (req.approvalStage === 'FINANCE') {
        req.financeApprovedAt = new Date().toISOString();
        req.financeComments = comments;
        
        // Move to MD
        const md = users.find(u => u.role === 'md');
        req.approvalStage = 'MD';
        req.currentApprover = md ? md.username : null;
        req.currentApproverName = md ? md.name : null;
        
        showAlert('Finance Manager approval completed. Requisition forwarded to MD.');
        
    } else if (req.approvalStage === 'MD') {
        req.mdApprovedAt = new Date().toISOString();
        req.mdComments = comments;
        
        // Final approval - requisition is fully approved
        req.status = 'APPROVED';
        req.finalApprovedBy = currentUser.name;
        req.finalApprovedAt = new Date().toISOString();
        req.approvalStage = 'COMPLETED';
        
        showAlert('Requisition fully approved by MD!');
    }
    
    // Save to localStorage
    saveToLocalStorage('requisitions', requisitions);
    
    showScreen('pendingApprovals');
}

// ===== REDIRECT APPROVER (ADMIN) =====
function showRedirectModal(reqId) {
    const req = requisitions.find(r => r.id === reqId);
    if (!req) return;
    
    document.getElementById('redirectReqId').value = reqId;
    
    // Populate approver dropdown based on current stage
    let approvers = [];
    if (req.approvalStage === 'HOD') {
        // Admin can redirect to ANY HOD regardless of department
        approvers = users.filter(u => u.role === 'hod');
    } else if (req.approvalStage === 'FINANCE') {
        approvers = users.filter(u => u.role === 'finance_manager');
    } else if (req.approvalStage === 'MD') {
        approvers = users.filter(u => u.role === 'md');
    }
    
    let html = `<option value="">Select New Approver for ${req.approvalStage} stage</option>`;
    if (approvers.length === 0) {
        html += `<option value="" disabled>No available approvers for this stage</option>`;
    } else {
        approvers.forEach(approver => {
            const currentTag = approver.username === req.currentApprover ? ' (Current)' : '';
            html += `<option value="${approver.username}">${approver.name} - ${approver.department}${currentTag}</option>`;
        });
    }
    document.getElementById('redirectApprover').innerHTML = html;
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('redirectModal'));
    modal.show();
}

function confirmRedirect() {
    const reqId = parseInt(document.getElementById('redirectReqId').value);
    const newApprover = document.getElementById('redirectApprover').value;
    const reason = document.getElementById('redirectReason').value;
    
    if (!newApprover) {
        showAlert('Please select a new approver', 'warning');
        return;
    }
    
    const req = requisitions.find(r => r.id === reqId);
    if (!req) {
        showAlert('Requisition not found', 'danger');
        return;
    }
    
    const approverUser = users.find(u => u.username === newApprover);
    if (!approverUser) {
        showAlert('Selected approver not found', 'danger');
        return;
    }
    
    console.log('=== REDIRECT DEBUG ===');
    console.log('Requisition:', req.number);
    console.log('Current Approver:', req.currentApprover);
    console.log('New Approver:', newApprover);
    console.log('New Approver Name:', approverUser.name);
    console.log('Approval Stage:', req.approvalStage);
    
    // Update current approver (this is the KEY field for routing)
    req.currentApprover = newApprover;
    req.currentApproverName = approverUser.name;
    
    // Update the specific stage approver
    if (req.approvalStage === 'HOD') {
        req.hodApprover = newApprover;
        req.hodApproverName = approverUser.name;
    } else if (req.approvalStage === 'FINANCE') {
        req.financeApprover = newApprover;
        req.financeApproverName = approverUser.name;
    } else if (req.approvalStage === 'MD') {
        req.mdApprover = newApprover;
        req.mdApproverName = approverUser.name;
    }
    
    // Add redirect log
    if (!req.redirectHistory) {
        req.redirectHistory = [];
    }
    req.redirectHistory.push({
        date: new Date().toISOString(),
        redirectedBy: currentUser.name,
        to: newApprover,
        toName: approverUser.name,
        reason: reason || 'Not specified',
        stage: req.approvalStage
    });
    
    console.log('Updated currentApprover to:', req.currentApprover);
    console.log('Redirect History:', req.redirectHistory);
    
    // Save to localStorage - CRITICAL
    const saved = saveToLocalStorage('requisitions', requisitions);
    
    if (saved) {
        console.log('‚úì Successfully saved to localStorage');
        showAlert(`‚úì Requisition ${req.number} redirected to ${approverUser.name} (${approverUser.department}) for ${req.approvalStage} approval.`, 'success');
    } else {
        console.error('‚úó Failed to save to localStorage');
        showAlert('Error saving redirect. Please try again.', 'danger');
        return;
    }
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('redirectModal'));
    if (modal) {
        modal.hide();
    }
    
    console.log('=== END REDIRECT DEBUG ===');
    
    loadAllRequisitions();
}

// ===== PENDING APPROVALS =====
function loadPendingApprovals() {
    let pending = [];
    let infoMessage = '';
    
    if (currentUser.role === 'admin') {
        pending = requisitions.filter(r => r.status === 'PENDING');
        infoMessage = 'Showing all pending requisitions (Admin view)';
    } else if (currentUser.role === 'hod') {
        // HOD can see: 1) All pending from their department OR 2) Any pending specifically assigned to them
        pending = requisitions.filter(r => 
            r.status === 'PENDING' && 
            (r.department === currentUser.department || r.currentApprover === currentUser.username)
        );
        infoMessage = `Showing pending requisitions for ${currentUser.department} department and any redirected to you`;
    } else if (currentUser.role === 'finance_manager') {
        // Finance Manager sees all pending requisitions
        pending = requisitions.filter(r => r.status === 'PENDING');
        infoMessage = 'Showing all pending requisitions (Finance Manager view)';
    } else if (currentUser.role === 'md') {
        // MD sees all pending requisitions
        pending = requisitions.filter(r => r.status === 'PENDING');
        infoMessage = 'Showing all pending requisitions (MD view)';
    } else {
        // Initiators see their own pending requisitions
        pending = requisitions.filter(r => r.status === 'PENDING' && r.createdBy === currentUser.username);
        infoMessage = 'Showing your pending requisitions';
    }
    
    document.getElementById('pendingApprovalsInfo').textContent = infoMessage;
    
    let html = '<table class="table"><thead><tr><th>Req #</th><th>Requestor</th><th>Department</th><th>Description</th><th>Amount</th><th>Current Stage</th><th>Awaiting</th><th>Created</th><th>Action</th></tr></thead><tbody>';
    
    if (pending.length === 0) {
        html += '<tr><td colspan="9" class="text-center">No pending approvals.</td></tr>';
    } else {
        pending.forEach(req => {
            // Determine if current user can review this requisition
            const canReview = currentUser.role === 'admin' ||
                            (req.approvalStage === 'HOD' && req.currentApprover === currentUser.username) ||
                            (req.approvalStage === 'FINANCE' && currentUser.role === 'finance_manager') ||
                            (req.approvalStage === 'MD' && currentUser.role === 'md');
            
            // Check if this was redirected to this user
            const isRedirected = req.redirectHistory && req.redirectHistory.length > 0 && 
                               req.currentApprover === currentUser.username &&
                               req.department !== currentUser.department;
            
            html += `<tr ${isRedirected ? 'class="table-warning"' : ''}>
                <td><a href="#" onclick="viewRequisition(${req.id})">${req.number}</a>${isRedirected ? ' <span class="badge bg-warning text-dark">Redirected</span>' : ''}</td>
                <td>${req.creatorName}</td>
                <td>${req.department}</td>
                <td>${req.description.substring(0, 30)}...</td>
                <td>${formatCurrency(req.totalCost)}</td>
                <td><span class="badge bg-info">${req.approvalStage}</span></td>
                <td>${req.currentApproverName || 'N/A'}</td>
                <td>${formatDate(req.createdAt)}</td>
                <td>
                    ${canReview ? `<button class="btn btn-sm btn-primary" onclick="viewRequisition(${req.id})">Review</button>` : 
                                  `<button class="btn btn-sm btn-secondary" onclick="viewRequisition(${req.id})">View</button>`}
                </td>
            </tr>`;
        });
    }
    
    html += '</tbody></table>';
    document.getElementById('pendingApprovalsList').innerHTML = html;
}

// ===== BUDGETS =====
let budgetEditMode = false;

function loadBudgets() {
    const userRole = currentUser.role;
    
    // Determine what user can see/do
    const canManage = userRole === 'admin' || userRole === 'finance_manager' || userRole === 'md';
    const isHOD = userRole === 'hod';
    
    console.log('=== BUDGET ACCESS DEBUG ===');
    console.log('User:', currentUser.name);
    console.log('Role:', userRole);
    console.log('Can Manage:', canManage);
    console.log('Is HOD:', isHOD);
    
    // Show/hide appropriate sections
    if (canManage) {
        document.getElementById('budgetManagementCard').classList.remove('hidden');
        document.getElementById('hodBudgetCard').classList.add('hidden');
        document.getElementById('budgetOverviewCards').classList.remove('hidden');
        console.log('Showing budget management interface');
    } else if (isHOD) {
        document.getElementById('budgetManagementCard').classList.add('hidden');
        document.getElementById('hodBudgetCard').classList.remove('hidden');
        document.getElementById('budgetOverviewCards').classList.add('hidden');
        console.log('Showing HOD view');
    }
    
    if (canManage) {
        loadBudgetManagement();
    } else if (isHOD) {
        loadHODBudgetView();
    }
    
    loadBudgetImpact();
}

function loadBudgetManagement() {
    // Load overview cards
    let overviewHTML = '';
    const totalBudget = departments.reduce((sum, dept) => sum + dept.budget, 0);
    const totalSpent = departments.reduce((sum, dept) => {
        const spent = requisitions
            .filter(r => r.department === dept.name && r.status === 'APPROVED')
            .reduce((s, r) => s + r.totalCost, 0);
        return sum + spent;
    }, 0);
    const totalAvailable = totalBudget - totalSpent;
    const overallPercentage = totalBudget > 0 ? ((totalSpent / totalBudget) * 100).toFixed(1) : 0;
    
    overviewHTML += `
        <div class="col-md-3">
            <div class="card text-white bg-primary">
                <div class="card-body">
                    <h6>Total Budget</h6>
                    <h3>${formatCurrency(totalBudget)}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-danger">
                <div class="card-body">
                    <h6>Total Spent</h6>
                    <h3>${formatCurrency(totalSpent)}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-success">
                <div class="card-body">
                    <h6>Available</h6>
                    <h3>${formatCurrency(totalAvailable)}</h3>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-white bg-warning">
                <div class="card-body">
                    <h6>Consumption</h6>
                    <h3>${overallPercentage}%</h3>
                </div>
            </div>
        </div>
    `;
    document.getElementById('budgetOverviewCards').innerHTML = overviewHTML;
    
    // Load budget table
    let tableHTML = '';
    departments.forEach(dept => {
        const spent = requisitions
            .filter(r => r.department === dept.name && r.status === 'APPROVED')
            .reduce((sum, r) => sum + r.totalCost, 0);
        const available = dept.budget - spent;
        const percentage = dept.budget > 0 ? ((spent / dept.budget) * 100).toFixed(1) : 0;
        
        let statusBadge = '';
        if (percentage < 50) {
            statusBadge = '<span class="badge bg-success">Healthy</span>';
        } else if (percentage < 80) {
            statusBadge = '<span class="badge bg-warning text-dark">Moderate</span>';
        } else if (percentage < 100) {
            statusBadge = '<span class="badge bg-danger">High</span>';
        } else {
            statusBadge = '<span class="badge bg-dark">Over Budget</span>';
        }
        
        tableHTML += `
            <tr>
                <td>${dept.name}</td>
                <td>${dept.accountCode}</td>
                <td>
                    ${budgetEditMode ? 
                        `<input type="number" class="form-control form-control-sm budget-input" 
                         data-dept="${dept.name}" value="${dept.budget}" min="0" step="1000">` :
                        formatCurrency(dept.budget)
                    }
                </td>
                <td>${formatCurrency(spent)}</td>
                <td class="${available < 0 ? 'text-danger fw-bold' : ''}">${formatCurrency(available)}</td>
                <td>
                    <div class="progress" style="height: 25px;">
                        <div class="progress-bar ${percentage >= 100 ? 'bg-danger' : percentage >= 80 ? 'bg-warning' : 'bg-success'}" 
                             role="progressbar" style="width: ${Math.min(percentage, 100)}%">
                            ${percentage}%
                        </div>
                    </div>
                </td>
                <td>${statusBadge}</td>
            </tr>
        `;
    });
    
    document.getElementById('budgetTableBody').innerHTML = tableHTML;
    
    // Update button text
    const editBtn = document.getElementById('editBudgetsBtn');
    if (budgetEditMode) {
        editBtn.innerHTML = '<i class="bi bi-check"></i> Save Budgets';
        editBtn.className = 'btn btn-sm btn-success';
    } else {
        editBtn.innerHTML = '<i class="bi bi-pencil"></i> Edit Budgets';
        editBtn.className = 'btn btn-sm btn-primary';
    }
}

function loadHODBudgetView() {
    const hodDept = departments.find(d => d.name === currentUser.department);
    if (!hodDept) {
        document.getElementById('hodBudgetView').innerHTML = '<p class="text-muted">No budget information available.</p>';
        return;
    }
    
    const spent = requisitions
        .filter(r => r.department === currentUser.department && r.status === 'APPROVED')
        .reduce((sum, r) => sum + r.totalCost, 0);
    const available = hodDept.budget - spent;
    const percentage = hodDept.budget > 0 ? ((spent / hodDept.budget) * 100).toFixed(1) : 0;
    
    let statusMessage = '';
    let statusClass = '';
    if (percentage < 50) {
        statusMessage = 'Budget is healthy. You have good spending capacity.';
        statusClass = 'alert-success';
    } else if (percentage < 80) {
        statusMessage = 'Budget consumption is moderate. Please monitor spending.';
        statusClass = 'alert-warning';
    } else if (percentage < 100) {
        statusMessage = 'Budget consumption is high. Exercise caution with new requisitions.';
        statusClass = 'alert-danger';
    } else {
        statusMessage = 'Budget exceeded! Please consult with Finance Manager.';
        statusClass = 'alert-dark';
    }
    
    const html = `
        <div class="alert ${statusClass}">
            <h5>${currentUser.department} Department Budget Status</h5>
            <p class="mb-0">${statusMessage}</p>
        </div>
        
        <div class="row mt-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Allocated Budget</h6>
                        <h3 class="text-primary">${formatCurrency(hodDept.budget)}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Spent</h6>
                        <h3 class="text-danger">${formatCurrency(spent)}</h3>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body text-center">
                        <h6 class="text-muted">Available</h6>
                        <h3 class="${available < 0 ? 'text-danger' : 'text-success'}">${formatCurrency(available)}</h3>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="card mt-4">
            <div class="card-body">
                <h6>Budget Consumption</h6>
                <div class="progress" style="height: 30px;">
                    <div class="progress-bar ${percentage >= 100 ? 'bg-danger' : percentage >= 80 ? 'bg-warning' : 'bg-success'}" 
                         role="progressbar" style="width: ${Math.min(percentage, 100)}%">
                        <strong>${percentage}% Used</strong>
                    </div>
                </div>
                <small class="text-muted mt-2 d-block">
                    ${percentage < 100 ? `${(100 - percentage).toFixed(1)}% remaining` : 'Budget exceeded'}
                </small>
            </div>
        </div>
    `;
    
    document.getElementById('hodBudgetView').innerHTML = html;
}

function loadBudgetImpact() {
    // Show recent approved requisitions and their impact
    const recentApproved = requisitions
        .filter(r => r.status === 'APPROVED')
        .sort((a, b) => new Date(b.finalApprovedAt) - new Date(a.finalApprovedAt))
        .slice(0, 10);
    
    let html = '';
    if (recentApproved.length === 0) {
        html = '<tr><td colspan="6" class="text-center text-muted">No approved requisitions yet</td></tr>';
    } else {
        recentApproved.forEach(req => {
            const dept = departments.find(d => d.name === req.department);
            const deptBudget = dept ? dept.budget : 0;
            const impactPercentage = deptBudget > 0 ? ((req.totalCost / deptBudget) * 100).toFixed(2) : 0;
            
            html += `
                <tr>
                    <td><a href="#" onclick="viewRequisition(${req.id})">${req.number}</a></td>
                    <td>${formatDate(req.finalApprovedAt)}</td>
                    <td>${req.department}</td>
                    <td>${req.description.substring(0, 40)}...</td>
                    <td>${formatCurrency(req.totalCost)}</td>
                    <td>
                        <span class="badge ${impactPercentage > 5 ? 'bg-danger' : impactPercentage > 2 ? 'bg-warning text-dark' : 'bg-success'}">
                            ${impactPercentage}% of budget
                        </span>
                    </td>
                </tr>
            `;
        });
    }
    
    document.getElementById('budgetImpactTableBody').innerHTML = html;
}

function toggleBudgetEdit() {
    if (budgetEditMode) {
        // Save mode - collect all budget inputs
        const inputs = document.querySelectorAll('.budget-input');
        let changes = [];
        
        inputs.forEach(input => {
            const deptName = input.getAttribute('data-dept');
            const newBudget = parseFloat(input.value) || 0;
            const dept = departments.find(d => d.name === deptName);
            
            if (dept && dept.budget !== newBudget) {
                dept.budget = newBudget;
                changes.push(`${deptName}: ${formatCurrency(newBudget)}`);
            }
        });
        
        if (changes.length > 0) {
            saveToLocalStorage('departments', departments);
            showAlert(`Budget updated for: ${changes.join(', ')}`, 'success');
        }
        
        budgetEditMode = false;
    } else {
        // Enter edit mode
        budgetEditMode = true;
    }
    
    loadBudgetManagement();
}
function loadApprovedRequisitions() {
    let approved = [];
    let infoMessage = '';
    
    if (currentUser.role === 'admin') {
        // Admin sees all approved requisitions
        approved = requisitions.filter(r => r.status === 'APPROVED');
        infoMessage = 'Showing all approved requisitions (Admin view)';
    } else if (currentUser.role === 'initiator') {
        // Initiators see only their own approved requisitions
        approved = requisitions.filter(r => 
            r.status === 'APPROVED' && 
            r.createdBy === currentUser.username
        );
        infoMessage = 'Showing your approved requisitions';
    } else if (currentUser.role === 'hod') {
        // HODs see: 1) All approved from their department OR 2) Any they approved (even if redirected from another department)
        approved = requisitions.filter(r => 
            r.status === 'APPROVED' && 
            (r.department === currentUser.department || r.hodApprover === currentUser.username)
        );
        infoMessage = `Showing approved requisitions for ${currentUser.department} department and any you approved`;
    } else if (currentUser.role === 'finance_manager') {
        // Finance Manager sees all approved requisitions
        approved = requisitions.filter(r => r.status === 'APPROVED');
        infoMessage = 'Showing all approved requisitions (Finance Manager view)';
    } else if (currentUser.role === 'md') {
        // MD sees all approved requisitions
        approved = requisitions.filter(r => r.status === 'APPROVED');
        infoMessage = 'Showing all approved requisitions (MD view)';
    }
    
    document.getElementById('approvedReqsInfo').textContent = infoMessage;
    
    let html = '<table class="table"><thead><tr><th>Req #</th><th>Requestor</th><th>Department</th><th>Description</th><th>Vendor</th><th>Amount</th><th>Approved Date</th><th>Actions</th></tr></thead><tbody>';
    
    if (approved.length === 0) {
        html += '<tr><td colspan="8" class="text-center">No approved requisitions found.</td></tr>';
    } else {
        approved.forEach(req => {
            html += `<tr>
                <td><a href="#" onclick="viewRequisition(${req.id})">${req.number}</a></td>
                <td>${req.creatorName}</td>
                <td>${req.department}</td>
                <td>${req.description.substring(0, 40)}...</td>
                <td>${req.vendor || 'N/A'}</td>
                <td>${formatCurrency(req.totalCost)}</td>
                <td>${formatDate(req.finalApprovedAt)}</td>
                <td class="action-buttons">
                    <button class="btn btn-sm btn-info" onclick="viewRequisition(${req.id})">View</button>
                    <button class="btn btn-sm btn-success" onclick="downloadRequisitionPDF(${req.id})">PDF</button>
                </td>
            </tr>`;
        });
    }
    
    html += '</tbody></table>';
    document.getElementById('approvedRequisitionsList').innerHTML = html;
}

// ===== REPORTS =====
function loadReports() {
    // Department spending
    let deptHtml = '<table class="table" id="deptSpendingTable"><thead><tr><th>Department</th><th>Account Code</th><th>Budget</th><th>Spent</th><th>Remaining</th><th>% Used</th></tr></thead><tbody>';
    
    departments.forEach(dept => {
        const spent = requisitions
            .filter(r => r.department === dept.name && r.status === 'APPROVED')
            .reduce((sum, r) => sum + r.totalCost, 0);
        const remaining = dept.budget - spent;
        const pct = dept.budget > 0 ? ((spent / dept.budget) * 100).toFixed(1) : 0;
        
        deptHtml += `<tr>
            <td>${dept.name}</td>
            <td>${dept.accountCode}</td>
            <td>${formatCurrency(dept.budget)}</td>
            <td>${formatCurrency(spent)}</td>
            <td>${formatCurrency(remaining)}</td>
            <td>${pct}%</td>
        </tr>`;
    });
    
    deptHtml += '</tbody></table>';
    document.getElementById('deptSpendingReport').innerHTML = deptHtml;
    
    // Status summary
    const statuses = ['DRAFT', 'PENDING', 'APPROVED', 'REJECTED'];
    let statusHtml = '<table class="table" id="statusSummaryTable"><thead><tr><th>Status</th><th>Count</th><th>Total Value</th></tr></thead><tbody>';
    
    statuses.forEach(status => {
        const reqs = requisitions.filter(r => r.status === status);
        const total = reqs.reduce((sum, r) => sum + r.totalCost, 0);
        
        statusHtml += `<tr>
            <td><span class="badge badge-${status.toLowerCase()}">${status}</span></td>
            <td>${reqs.length}</td>
            <td>${formatCurrency(total)}</td>
        </tr>`;
    });
    
    statusHtml += '</tbody></table>';
    document.getElementById('statusSummaryReport').innerHTML = statusHtml;
}

// ===== PDF DOWNLOADS =====
function downloadRequisitionPDF(reqId) {
    const req = requisitions.find(r => r.id === reqId);
    if (!req) return;
    
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Title
    doc.setFontSize(18);
    doc.text('Purchase Requisition', 105, 20, { align: 'center' });
    
    // Requisition details
    doc.setFontSize(12);
    let y = 40;
    doc.text(`Requisition Number: ${req.number}`, 20, y);
    y += 10;
    doc.text(`Status: ${req.status}`, 20, y);
    y += 10;
    doc.text(`Department: ${req.department} (${req.accountCode})`, 20, y);
    y += 10;
    doc.text(`Requestor: ${req.creatorName}`, 20, y);
    y += 10;
    doc.text(`Created: ${formatDate(req.createdAt)}`, 20, y);
    y += 10;
    doc.text(`Vendor: ${req.vendor}`, 20, y);
    y += 10;
    doc.text(`Delivery Location: ${req.deliveryLocation}`, 20, y);
    y += 10;
    doc.text(`Urgency: ${req.urgency}`, 20, y);
    y += 15;
    
    // Items table
    doc.setFontSize(14);
    doc.text('Items', 20, y);
    y += 5;
    
    const items = req.items && req.items.length > 0 ? req.items : [{
        description: req.description,
        quantity: req.quantity || 1,
        unitCost: req.unitCost || 0,
        total: req.totalCost
    }];
    
    const tableData = items.map((item, index) => [
        (index + 1).toString(),
        item.description,
        item.quantity.toString(),
        formatCurrency(item.unitCost),
        formatCurrency(item.total)
    ]);
    
    doc.autoTable({
        startY: y,
        head: [['#', 'Description', 'Qty', 'Unit Cost', 'Total']],
        body: tableData,
        foot: [['', '', '', 'Grand Total:', formatCurrency(req.totalCost)]],
        theme: 'grid',
        styles: { fontSize: 10 },
        headStyles: { fillColor: [66, 139, 202] },
        footStyles: { fillColor: [240, 240, 240], textColor: [0, 0, 0], fontStyle: 'bold' }
    });
    
    y = doc.lastAutoTable.finalY + 15;
    
    // Justification
    if (y > 250) {
        doc.addPage();
        y = 20;
    }
    
    doc.setFontSize(14);
    doc.text('Justification', 20, y);
    y += 10;
    doc.setFontSize(11);
    const justificationLines = doc.splitTextToSize(req.justification, 170);
    doc.text(justificationLines, 20, y);
    y += justificationLines.length * 7 + 10;
    
    // Approval details
    if (req.status === 'APPROVED' || req.status === 'REJECTED') {
        if (y > 250) {
            doc.addPage();
            y = 20;
        }
        
        doc.setFontSize(14);
        doc.text('Approval Details', 20, y);
        y += 10;
        doc.setFontSize(11);
        
        if (req.hodApprovedAt) {
            doc.text(`HOD: Approved by ${req.hodApproverName} on ${formatDate(req.hodApprovedAt)}`, 20, y);
            y += 7;
        }
        if (req.financeApprovedAt) {
            doc.text(`Finance: Approved by ${req.financeApproverName} on ${formatDate(req.financeApprovedAt)}`, 20, y);
            y += 7;
        }
        if (req.mdApprovedAt) {
            doc.text(`MD: Approved by ${req.mdApproverName} on ${formatDate(req.mdApprovedAt)}`, 20, y);
            y += 7;
        }
        if (req.rejectedAt) {
            doc.text(`Rejected by ${req.rejectedBy} on ${formatDate(req.rejectedAt)}`, 20, y);
            y += 7;
            if (req.rejectionComments) {
                doc.text(`Reason: ${req.rejectionComments}`, 20, y);
            }
        }
    }
    
    doc.save(`Requisition_${req.number}.pdf`);
}

function downloadReportsPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    
    // Title
    doc.setFontSize(18);
    doc.text('Purchase Management Reports', 105, 20, { align: 'center' });
    doc.setFontSize(12);
    doc.text(`Generated: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
    
    // Department Spending Table
    doc.setFontSize(14);
    doc.text('Spending by Department', 20, 45);
    
    const deptData = departments.map(dept => {
        const spent = requisitions
            .filter(r => r.department === dept.name && r.status === 'APPROVED')
            .reduce((sum, r) => sum + r.totalCost, 0);
        const remaining = dept.budget - spent;
        const pct = dept.budget > 0 ? ((spent / dept.budget) * 100).toFixed(1) : 0;
        
        return [
            dept.name,
            dept.accountCode,
            formatCurrency(dept.budget),
            formatCurrency(spent),
            formatCurrency(remaining),
            pct + '%'
        ];
    });
    
    doc.autoTable({
        startY: 50,
        head: [['Department', 'Account Code', 'Budget', 'Spent', 'Remaining', '% Used']],
        body: deptData,
    });
    
    // Status Summary Table
    const finalY = doc.lastAutoTable.finalY + 15;
    doc.setFontSize(14);
    doc.text('Status Summary', 20, finalY);
    
    const statuses = ['DRAFT', 'PENDING', 'APPROVED', 'REJECTED'];
    const statusData = statuses.map(status => {
        const reqs = requisitions.filter(r => r.status === status);
        const total = reqs.reduce((sum, r) => sum + r.totalCost, 0);
        return [status, reqs.length.toString(), formatCurrency(total)];
    });
    
    doc.autoTable({
        startY: finalY + 5,
        head: [['Status', 'Count', 'Total Value']],
        body: statusData,
    });
    
    doc.save('Purchase_Reports.pdf');
}

function downloadReportsExcel() {
    // Create CSV content
    let csv = 'Purchase Management Reports\n';
    csv += 'Generated: ' + new Date().toLocaleDateString() + '\n\n';
    
    // Department Spending
    csv += 'Spending by Department\n';
    csv += 'Department,Account Code,Budget,Spent,Remaining,% Used\n';
    
    departments.forEach(dept => {
        const spent = requisitions
            .filter(r => r.department === dept.name && r.status === 'APPROVED')
            .reduce((sum, r) => sum + r.totalCost, 0);
        const remaining = dept.budget - spent;
        const pct = dept.budget > 0 ? ((spent / dept.budget) * 100).toFixed(1) : 0;
        
        csv += `${dept.name},${dept.accountCode},${dept.budget},${spent},${remaining},${pct}%\n`;
    });
    
    csv += '\n\nStatus Summary\n';
    csv += 'Status,Count,Total Value\n';
    
    const statuses = ['DRAFT', 'PENDING', 'APPROVED', 'REJECTED'];
    statuses.forEach(status => {
        const reqs = requisitions.filter(r => r.status === status);
        const total = reqs.reduce((sum, r) => sum + r.totalCost, 0);
        csv += `${status},${reqs.length},${total}\n`;
    });
    
    // Download
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'Purchase_Reports.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

// ===== ADMIN PANEL =====
function loadAdminPanel() {
    if (currentUser.role !== 'admin') {
        showAlert('Access denied. Admin only.', 'danger');
        showScreen('dashboard');
        return;
    }
    
    // Load users
    let userHtml = '<table class="table"><thead><tr><th>Name</th><th>Username</th><th>Role</th><th>Department</th><th>HOD</th><th>Actions</th></tr></thead><tbody>';
    users.forEach(user => {
        const hod = user.hod ? users.find(u => u.username === user.hod) : null;
        userHtml += `<tr>
            <td>${user.name}</td>
            <td>${user.username}</td>
            <td>${user.role}</td>
            <td>${user.department}</td>
            <td>${hod ? hod.name : '-'}</td>
            <td>${user.role !== 'admin' ? `<button class="btn btn-sm btn-danger" onclick="deleteUser(${user.id})">Delete</button>` : '-'}</td>
        </tr>`;
    });
    userHtml += '</tbody></table>';
    document.getElementById('usersList').innerHTML = userHtml;
    
    // Load vendors
    let vendorHtml = '<table class="table"><thead><tr><th>Vendor Name</th><th>Actions</th></tr></thead><tbody>';
    vendors.forEach((vendor, index) => {
        vendorHtml += `<tr>
            <td>${vendor}</td>
            <td><button class="btn btn-sm btn-danger" onclick="deleteVendor(${index})">Delete</button></td>
        </tr>`;
    });
    vendorHtml += '</tbody></table>';
    document.getElementById('vendorsList').innerHTML = vendorHtml;
    
    // Load departments
    let deptHtml = '<table class="table"><thead><tr><th>Department</th><th>Account Code</th><th>Budget</th></tr></thead><tbody>';
    departments.forEach(dept => {
        deptHtml += `<tr>
            <td>${dept.name}</td>
            <td>${dept.accountCode}</td>
            <td>${formatCurrency(dept.budget)}</td>
        </tr>`;
    });
    deptHtml += '</tbody></table>';
    document.getElementById('departmentsList').innerHTML = deptHtml;
    
    // Update storage counts
    document.getElementById('userCount').textContent = users.length;
    document.getElementById('reqCount').textContent = requisitions.length;
    document.getElementById('vendorCount').textContent = vendors.length;
    
    // Populate HOD dropdown
    updateHODDropdown();
}

// ===== DATA EXPORT/IMPORT =====
function exportAllData() {
    const data = {
        users: users,
        requisitions: requisitions,
        vendors: vendors,
        departments: departments,
        requisitionCounter: requisitionCounter,
        exportedAt: new Date().toISOString()
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `purchase_system_backup_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    window.URL.revokeObjectURL(url);
    showAlert('Data exported successfully!');
}

function importAllData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const data = JSON.parse(e.target.result);
            
            if (confirm('This will replace ALL current data. Are you sure?')) {
                if (data.users) {
                    users = data.users;
                    saveToLocalStorage('users', users);
                }
                if (data.requisitions) {
                    requisitions = data.requisitions;
                    saveToLocalStorage('requisitions', requisitions);
                }
                if (data.vendors) {
                    vendors = data.vendors;
                    saveToLocalStorage('vendors', vendors);
                }
                if (data.departments) {
                    departments = data.departments;
                    saveToLocalStorage('departments', departments);
                }
                if (data.requisitionCounter) {
                    requisitionCounter = data.requisitionCounter;
                    saveToLocalStorage('requisitionCounter', requisitionCounter);
                }
                
                showAlert('Data imported successfully! Reloading...');
                setTimeout(() => location.reload(), 1000);
            }
        } catch (error) {
            showAlert('Error importing data: ' + error.message, 'danger');
        }
    };
    reader.readAsText(file);
    
    // Reset file input
    event.target.value = '';
}

function updateHODDropdown() {
    const hods = users.filter(u => u.role === 'hod' || u.role === 'finance_manager' || u.role === 'md');
    let html = '<option value="">N/A (for HODs/Admin/FM/MD)</option>';
    hods.forEach(hod => {
        html += `<option value="${hod.username}">${hod.name} - ${hod.department}</option>`;
    });
    document.getElementById('userHOD').innerHTML = html;
}

function showAddUser() {
    document.getElementById('addUserForm').classList.remove('hidden');
    updateHODDropdown();
    
    // Reset and setup role change handler
    const roleField = document.getElementById('userRole');
    const hodContainer = document.getElementById('hodFieldContainer');
    
    // Remove any existing listeners
    const newRoleField = roleField.cloneNode(true);
    roleField.parentNode.replaceChild(newRoleField, roleField);
    
    // Add fresh listener
    newRoleField.addEventListener('change', function() {
        if (this.value === 'initiator') {
            hodContainer.style.display = 'block';
            document.getElementById('userHOD').required = true;
        } else {
            hodContainer.style.display = 'none';
            document.getElementById('userHOD').required = false;
            document.getElementById('userHOD').value = '';
        }
    });
    
    // Initial state
    if (newRoleField.value === 'initiator') {
        hodContainer.style.display = 'block';
    } else {
        hodContainer.style.display = 'none';
    }
}

function hideAddUser() {
    document.getElementById('addUserForm').classList.add('hidden');
    document.getElementById('userForm').reset();
}

document.getElementById('userForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const username = document.getElementById('userUsername').value.trim();
    const name = document.getElementById('userName').value.trim();
    const password = document.getElementById('userPassword').value;
    const role = document.getElementById('userRole').value;
    const department = document.getElementById('userDepartment').value;
    const hod = document.getElementById('userHOD').value || null;
    
    // Validation
    if (!username || !name || !password || !role || !department) {
        showAlert('Please fill in all required fields!', 'danger');
        return;
    }
    
    if (users.find(u => u.username === username)) {
        showAlert('Username already exists! Please choose a different username.', 'danger');
        return;
    }
    
    // Validate initiator has HOD
    if (role === 'initiator' && !hod) {
        showAlert('Initiators must have a HOD assigned!', 'danger');
        return;
    }
    
    const user = {
        id: Date.now(),
        name: name,
        username: username,
        password: password,
        role: role,
        department: department,
        hod: hod
    };
    
    users.push(user);
    
    // Save to localStorage
    const saved = saveToLocalStorage('users', users);
    
    if (saved) {
        showAlert(`User "${name}" added successfully! They can now login with username: ${username}`, 'success');
        hideAddUser();
        loadAdminPanel();
    } else {
        showAlert('Error saving user. Please try again.', 'danger');
    }
});

function deleteUser(userId) {
    if (confirm('Are you sure you want to delete this user?')) {
        users = users.filter(u => u.id !== userId);
        saveToLocalStorage('users', users);
        showAlert('User deleted.');
        loadAdminPanel();
    }
}

function showAddVendor() {
    document.getElementById('addVendorForm').classList.remove('hidden');
}

function hideAddVendor() {
    document.getElementById('addVendorForm').classList.add('hidden');
    document.getElementById('vendorForm').reset();
}

document.getElementById('vendorForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const vendorName = document.getElementById('vendorName').value;
    if (vendors.includes(vendorName)) {
        showAlert('Vendor already exists!', 'danger');
        return;
    }
    
    vendors.push(vendorName);
    vendors.sort();
    saveToLocalStorage('vendors', vendors);
    showAlert('Vendor added successfully!');
    hideAddVendor();
    loadAdminPanel();
});

function deleteVendor(index) {
    if (confirm('Are you sure you want to delete this vendor?')) {
        vendors.splice(index, 1);
        saveToLocalStorage('vendors', vendors);
        showAlert('Vendor deleted.');
        loadAdminPanel();
    }
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>